<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medições PPCI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: url('https://i.ibb.co/Kz2Bk089/Apresenta-o-Casa-Castilho-17-Editado.png') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
            color: #000;
        }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #E21B2F;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #c7172a;
        }
        .btn-secondary {
            background-color: #e9ecef;
            color: #495057;
        }
        .btn-secondary:hover {
            background-color: #dee2e6;
        }
        .tab-btn {
            flex-grow: 1;
            padding: 1rem;
            border-radius: 9999px;
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
        }
        .tab-btn.active {
            background-color: #494C4F;
            color: #fff;
        }

        /* Estilos para campos de input para garantir visibilidade */
        input[type="text"], input[type="number"], input[type="date"], textarea, select {
            color: #000;
        }

        .medicoes-list-item {
            color: #000;
        }

        /* Estilos para a aba de Cronograma */
        .gantt-container {
            overflow-x: auto;
            margin-bottom: 2rem;
        }
        .gantt-chart {
            min-width: 100%;
            display: grid;
            grid-template-columns: 200px repeat(30, 1fr);
            gap: 2px;
            margin-top: 1rem;
        }
        .gantt-header {
            background-color: #494C4F;
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-weight: bold;
        }
        .gantt-task {
            background-color: #e9ecef;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 2px;
            cursor: move;
        }
        .gantt-cell {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            min-height: 40px;
        }
        .gantt-cell.active {
            background-color: #E21B2F;
            opacity: 0.6;
        }

        /* Estilo para a Curva S */
        .curva-s-container {
            margin-top: 2rem;
            height: 300px;
        }

        /* Estilo para a lista de despesas */
        .despesa-item {
            border-left: 4px solid #E21B2F;
            padding-left: 1rem;
            margin-bottom: 1rem;
            color: #000;
        }
        
        /* Estilo para formulários de despesas */
        .despesa-form label {
            color: #000;
        }
        .despesa-form input, .despesa-form select, .despesa-form textarea {
            color: #000;
        }

        /* Novas regras do Gantt */
        .gantt-task-bar {
            height: 20px;
            background-color: #E21B2F;
            border-radius: 4px;
            position: absolute;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .gantt-task-handle {
            width: 6px;
            height: 100%;
            position: absolute;
            cursor: ew-resize;
            background-color: rgba(0, 0, 0, 0.3);
        }
        
        .gantt-task-handle-left {
            left: 0;
        }
        
        .gantt-task-handle-right {
            right: 0;
        }
        
        .gantt-grid {
            display: grid;
            grid-template-columns: 200px repeat(30, 1fr);
            gap: 2px;
            margin-top: 1rem;
        }
        
        .gantt-day-cell {
            border: 1px solid #dee2e6;
            min-height: 40px;
            position: relative;
        }
        
        .gantt-day-cell.weekend {
            background-color: #f8f9fa;
        }
        
        .gantt-day-cell.today {
            background-color: #fff3cd;
        }
        
        .gantt-row {
            display: contents;
        }
        
        .gantt-row-label {
            background-color: #f8f9fa;
            padding: 10px;
            border: 1px solid #dee2e6;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <div id="header-container" class="flex items-center justify-between mb-8 flex-wrap">
        <div class="flex items-center space-x-4 mb-4 md:mb-0">
            <img src="https://storage.googleapis.com/ecdt-logo-saida/721cb85e8ac2d398795a63e738d194fd4ab80aca16543ac9858e119ba5215aa7/CASA-CASTILHO-COM-DE-EXTINTORES-E-EQUIPAMENTOS-DE-SEGUR.webp" alt="Logo" class="w-20 h-20">
            <div>
                <h1 class="text-3xl font-bold text-white">Medições PPCI</h1>
                <p class="text-white">Sistema de Gestão de Obras</p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <span class="text-white">ID: <span id="userIdDisplay" class="font-mono"></span></span>
            <button id="logout-btn" class="btn btn-secondary">Sair</button>
        </div>
    </div>
    
    <div id="main-content">
        <div id="login-view" class="card">
            <h2 class="text-2xl font-semibold mb-4 text-center">Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="login-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <button type="submit" id="login-btn" class="btn btn-primary w-full">Entrar</button>
                <button type="button" id="create-account-btn" class="btn btn-secondary w-full">Criar Conta</button>
            </form>
        </div>

        <div id="app-view" class="hidden">
            <div class="flex flex-wrap bg-gray-200 p-2 rounded-full space-x-2 mb-8">
                <button class="tab-btn active" data-tab="obras">Obras</button>
                <button class="tab-btn" data-tab="tarefas">Tarefas</button>
                <button class="tab-btn" data-tab="cronograma">Cronograma</button>
                <button class="tab-btn" data-tab="relatorios">Relatórios</button>
                <button class="tab-btn" data-tab="despesas">Despesas</button>
            </div>

            <div id="content" class="card">
                <div id="obras-view" class="tab-content active">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold mb-2 md:mb-0">Gerenciar Obras</h2>
                        <button id="add-obra-btn" class="btn btn-primary flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            <span>Nova Obra</span>
                        </button>
                    </div>
                    <div id="obras-list" class="space-y-4">
                        </div>
                </div>

                <div id="tarefas-view" class="tab-content hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold mb-2 md:mb-0">Tarefas da Obra</h2>
                        <button id="add-tarefa-btn" class="btn btn-primary flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            <span>Nova Tarefa</span>
                        </button>
                    </div>
                    <div id="tarefas-list" class="space-y-6">
                        </div>
                </div>

                <div id="cronograma-view" class="tab-content hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold mb-2 md:mb-0">Cronograma da Obra</h2>
                        <div class="flex space-x-2">
                            <!-- REMOVIDO: botão de adicionar tarefa no cronograma -->
<!--
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                <span>Adicionar Tarefa</span>
                            -->
                            <button id="gerar-cronograma-btn" class="btn btn-secondary flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                                </svg>
                                <span>Gerar Cronograma</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="cronograma-dias" class="block text-sm font-medium text-gray-700">Duração do Cronograma (dias)</label>
                        <input type="number" id="cronograma-dias" min="1" value="30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    
                    <div class="gantt-container">
                        <div id="gantt-chart" class="gantt-chart">
                            </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold mb-4 mt-8">Curva S - Evolução Financeira</h3>
                    <div class="curva-s-container">
                        <canvas id="curva-s-chart"></canvas>
                    </div>
                </div>

                <div id="relatorios-view" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold mb-6">Relatórios</h2>
                    <div id="relatorio-content" class="space-y-6">
                        </div>
                </div>

                <div id="despesas-view" class="tab-content hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold mb-2 md:mb-0">Despesas da Obra</h2>
                        <div class="flex space-x-2">
                            <button id="add-despesa-btn" class="btn btn-primary flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                <span>Nova Despesa</span>
                            </button>
                            <button id="gerar-relatorio-despesas-btn" class="btn btn-secondary flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                <span>Relatório</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <p class="text-gray-500">Total de Despesas</p>
                            <p id="total-despesas" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <p class="text-gray-500">Maior Despesa</p>
                            <p id="maior-despesa" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <p class="text-gray-500">Média por Dia</p>
                            <p id="media-despesas" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                    
                    <div id="relatorio-despesas-container" class="hidden mb-8">
                        <h3 class="text-xl font-semibold mb-4">Relatório de Despesas por Período</h3>
                        <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-4 md:space-y-0 mb-4">
                            <div class="flex-1">
                                <label for="despesa-start-date" class="block text-sm font-medium text-gray-700">Data de Início</label>
                                <input type="date" id="despesa-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div class="flex-1">
                                <label for="despesa-end-date" class="block text-sm font-medium text-gray-700">Data de Fim</label>
                                <input type="date" id="despesa-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <button id="generate-despesa-report-btn" class="btn btn-primary">Gerar Relatório</button>
                        </div>
                        <div id="despesa-period-report-result" class="mt-6">
                            </div>
                    </div>
                    
                    <div id="despesas-list" class="space-y-4">
                        </div>
                </div>
    
            </div>
        </div>

        <!-- Modal Structure -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
                    <div id="modal-body" class="mt-2 px-7 py-3">
                        </div>
                    <div class="items-center px-4 py-3">
                        <button id="modal-close-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, getDoc, setDoc, query, where } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // Variáveis globais
    let userId = null;
    let currentObraId = null;
    let lastUserId = null; // Para evitar re-renderizações desnecessárias ao mudar de aba
    let curvaSChart = null; // Instância do Chart.js para a Curva S
    let ganttTasks = []; // Armazena as tarefas para o Gantt
    let isDragging = false;
    let currentDragElement = null;
    let dragStartX = 0;
    let originalStartDay = 0;
    let originalEndDay = 0;
    let dragType = "";

    // Elementos do DOM
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const loginForm = document.getElementById('login-form');
    const loginBtn = document.getElementById('login-btn');
    const createAccountBtn = document.getElementById('create-account-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const obrasList = document.getElementById('obras-list');
    const addObraBtn = document.getElementById('add-obra-btn');
    const tarefasList = document.getElementById('tarefas-list');
    const addTarefaBtn = document.getElementById('add-tarefa-btn');
    const relatorioContent = document.getElementById('relatorio-content');
    const despesasList = document.getElementById('despesas-list');
    const addDespesaBtn = document.getElementById('add-despesa-btn');
    const gerarRelatorioDespesasBtn = document.getElementById('gerar-relatorio-despesas-btn');
    const cronogramaDias = document.getElementById('cronograma-dias');
    const ganttChart = document.getElementById('gantt-chart');
    const gerarCronogramaBtn = document.getElementById('gerar-cronograma-btn');
    const addTarefaCronogramaBtn = document.getElementById('add-tarefa-cronograma-btn'); // Adicionado

    // Funções utilitárias
    const openModal = (title, content) => {
        document.getElementById('modal-title').innerHTML = title;
        document.getElementById('modal-body').innerHTML = content;
        document.getElementById('modal').classList.remove('hidden');
    };

    const closeModal = () => {
        document.getElementById('modal').classList.add('hidden');
    };

    document.getElementById('modal-close-btn').addEventListener('click', closeModal);

    const formatCurrency = (value) => {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    };

    const calculatePercentage = (part, total) => {
        if (total === 0) return 0;
        return (part / total) * 100;
    };

    // Tab switching logic
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.add('hidden'));

            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-view`).classList.remove('hidden');

            if (tab.dataset.tab === 'tarefas') {
                if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click(); // Go back to obras tab
                } else {
                    renderTarefas();
                }
            } else if (tab.dataset.tab === 'relatorios') {
                 if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click(); // Go back to obras tab
                } else {
                    renderRelatorios();
                }
            } else if (tab.dataset.tab === 'cronograma') {
                 if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click(); // Go back to obras tab
                } else {
                    renderCronograma();
                }
            } else if (tab.dataset.tab === 'despesas') {
                 if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click(); // Go back to obras tab
                } else {
                    renderDespesas();
                }
            }
        });
    });

    // Firebase Initialization & Auth
    // TODO: Substitua os placeholders abaixo com suas configurações reais do Firebase e da API Gemini.
    const __firebase_config = {
        apiKey: "AIzaSyDrTvlOw8Ug2-GvBa2hkqDYKF7avhZ5cFA",
        authDomain: "medicoes-ppci.firebaseapp.com",
        projectId: "medicoes-ppci",
        storageBucket: "medicoes-ppci.firebasestorage.app",
        messagingSenderId: "408815173796",
        appId: "1:408815173796:web:efd25d921a7f0ee923e631"
    };
    const __app_id = "medicoes-ppci"; // Usado para caminhos no Firestore, geralmente o projectId
    const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY"; // Chave da API Gemini para geração de descrição
    const GEMINI_API_URL_GENERATE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=";

    let app; // Declarar 'app' com 'let' para evitar ser global implícita
    let auth; // Declarar 'auth' com 'let'
    let db; // Declarar 'db' com 'let'
    let audioContext;

    const initFirebase = async () => {
    try {
        app = initializeApp(__firebase_config);
        auth = getAuth(app);
        db = getFirestore(app);
        audioContext = new (window.AudioContext || window.webkitAudioContext)();

        let alreadyInitialized = false;

        

onAuthStateChanged(auth, async (user) => {
    if (user) {
        // Usuário logado → mostra app
        userId = user.uid;
        userIdDisplay.textContent = userId;
        loginView.classList.add('hidden');
        appView.classList.remove('hidden');

        if (!lastUserId || lastUserId !== user.uid) {
            lastUserId = user.uid;
            listenToObras();
        }
    } else {
        // Nenhum usuário logado → mostra login
        userId = null;
        lastUserId = null;
        userIdDisplay.textContent = "N/A";
        appView.classList.add('hidden');
        loginView.classList.remove('hidden');
    }
});
} catch (error) {
        console.error("Erro ao inicializar Firebase ou autenticar:", error);
    }
};
    
    loginBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            openModal('Erro de Login', `<p class="text-center text-gray-700">Ocorreu um erro ao fazer login: ${error.message}</p>`);
        }
    });
    
    createAccountBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            openModal('Sucesso', '<p class="text-center text-green-600">Conta criada com sucesso! Você foi logado automaticamente.</p>');
        } catch (error) {
            openModal('Erro ao Criar Conta', `<p class="text-center text-gray-700">Ocorreu um erro ao criar a conta: ${error.message}</p>`);
        }
    });

    logoutBtn.addEventListener('click', async () => {
        await signOut(auth);
        currentObraId = null; // Reset current obra
        tabs[0].click(); // Go back to obras tab
    });

    // Firestore CRUD Operations
    const listenToObras = () => {
        if (!db || !userId) {
            console.error("Firestore ou UserID não inicializados. Tente novamente.");
            return;
        }
        const obrasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras`);
        onSnapshot(obrasRef, (snapshot) => {
            const obras = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderObras(obras);
        });
    };

    const addOrUpdateObra = async (obra) => {
        if (!db) {
            console.error("Firestore não inicializado.");
            return;
        }

        const obrasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras`);
        if (obra.id) {
            const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, obra.id);
            await updateDoc(docRef, obra);
        } else {
            // Remove o campo 'id' para evitar o erro "Unsupported field value: undefined (found in field id)"
            const { id, ...newObraData } = obra;
            await addDoc(obrasRef, newObraData);
        }
        closeModal();
    };

    const deleteObra = async (obraId) => {
        const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, obraId);
        await deleteDoc(docRef);
    }
    
    const addOrUpdateTarefa = async (tarefa) => {
        if (!currentObraId) return;
        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        if (tarefa.id) {
            const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefa.id);
            await updateDoc(docRef, tarefa);
        } else {
            const { id, ...newTarefaData } = tarefa;
            await addDoc(tarefasRef, newTarefaData);
        }
        closeModal();
    };

    const deleteTarefa = async (tarefaId) => {
        const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        await deleteDoc(docRef);
    }

    const addMedicaoToTarefa = async (tarefaId, medicao) => {
        if (!currentObraId) return;
        const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        const tarefaDoc = await getDoc(tarefaDocRef);
        const tarefa = tarefaDoc.data();
        if (!tarefa.medicoes) {
            tarefa.medicoes = [];
        }
        tarefa.medicoes.push(medicao);
        await updateDoc(tarefaDocRef, { medicoes: tarefa.medicoes });
    };

    const updateMedicaoInTarefa = async (tarefaId, medicaoIndex, updatedMedicao) => {
        if (!currentObraId) return;
        const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        const tarefaDoc = await getDoc(tarefaDocRef);
        const tarefa = tarefaDoc.data();
        if (tarefa.medicoes && tarefa.medicoes[medicaoIndex]) {
            tarefa.medicoes[medicaoIndex] = updatedMedicao;
            await updateDoc(tarefaDocRef, { medicoes: tarefa.medicoes });
        }
    }

    const deleteMedicao = async (tarefaId, medicaoIndex) => {
        const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        const tarefaDoc = await getDoc(tarefaDocRef);
        const tarefa = tarefaDoc.data();
        
        if (tarefa.medicoes && tarefa.medicoes[medicaoIndex]) {
            tarefa.medicoes.splice(medicaoIndex, 1);
            await updateDoc(tarefaDocRef, { medicoes: tarefa.medicoes });
            // Re-render the list to show the change
            openMedicoesList(tarefaId, tarefa.medicoes);
        }
    };
    
    // CRUD para Cronograma
    const addOrUpdateCronograma = async (cronogramaData) => {
        if (!currentObraId) return;
        const cronogramaRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}`, 'cronograma');
        await setDoc(cronogramaRef, cronogramaData, { merge: true });
    };

    const getCronograma = async () => {
        if (!currentObraId) return null;
        const cronogramaRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}`, 'cronograma');
        const cronogramaDoc = await getDoc(cronogramaRef);
        return cronogramaDoc.exists() ? cronogramaDoc.data() : null;
    };

    // CRUD para Despesas
    const addOrUpdateDespesa = async (despesa) => {
        if (!currentObraId) return;
        const despesasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/despesas`);
        if (despesa.id) {
            const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/despesas`, despesa.id);
            await updateDoc(docRef, despesa);
        } else {
            const { id, ...newDespesaData } = despesa;
            await addDoc(despesasRef, newDespesaData);
        }
        closeModal();
    };

    const deleteDespesa = async (despesaId) => {
        const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/despesas`, despesaId);
        await deleteDoc(docRef);
    }
    
    // Render functions
    const renderObras = (obras) => {
        obrasList.innerHTML = '';
        obras.forEach(obra => {
            const obraCard = document.createElement('div');
            obraCard.className = 'card cursor-pointer hover:bg-gray-50';
            obraCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-2m2 0a2 2 0 01-2-2v-4m2 4v2m-6 2H9m1.5-12h3M9 16h6m-5-6h4"></path>
                        </svg>
                        <div>
                            <p class="font-bold text-lg">${obra.nome}</p>
                            <p class="text-gray-500 text-sm">${obra.localizacao}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="edit-obra-btn text-gray-500 hover:text-gray-700" data-id="${obra.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5.5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293zM14.707 5.293a1 1 0 011.414 0l1.586 1.586a1 1 0 010 1.414l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5.5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293z"></path>
                            </svg>
                        </button>
                         <button class="delete-obra-btn text-gray-500 hover:text-gray-700" data-id="${obra.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-500">Valor Total: <span class="text-green-600 font-semibold">${formatCurrency(obra.valorTotal || 0)}</span></p>
                </div>
            `;
            obraCard.addEventListener('click', () => {
                currentObraId = obra.id;
                tabs[1].click(); // Switch to Tarefas tab
            });
            obrasList.appendChild(obraCard);
        });
        document.querySelectorAll('.edit-obra-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const obraId = e.currentTarget.dataset.id;
                const obra = obras.find(o => o.id === obraId);
                openObraForm(obra);
            });
        });
        document.querySelectorAll('.delete-obra-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const obraId = e.currentTarget.dataset.id;
                openModal('Confirmação', `
                    <p class="text-center text-gray-700 mb-4">Tem certeza que deseja deletar esta obra?</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirmDeleteBtn" class="btn btn-primary">Sim</button>
                        <button id="cancelDeleteBtn" class="btn btn-secondary">Não</button>
                    </div>
                `);
                document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                    deleteObra(obraId);
                    closeModal();
                });
                document.getElementById('cancelDeleteBtn').addEventListener('click', closeModal);
            });
        });
    };
    
    const renderTarefas = () => {
        if (!currentObraId) return;
        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        onSnapshot(tarefasRef, (snapshot) => {
            tarefasList.innerHTML = '';
            let totalMedido = 0;
            const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            tarefas.forEach(tarefa => {
                const valorMedido = (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
                const porcentagemConcluida = calculatePercentage(valorMedido, tarefa.valorTotal);
                const metragemConcluida = (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.metragem || 0), 0);
                const valorUnitario = tarefa.metragemTotal > 0 ? (tarefa.valorTotal / tarefa.metragemTotal) : 0;

                totalMedido += valorMedido;

                const tarefaCard = document.createElement('div');
                tarefaCard.className = 'card w-full';
                tarefaCard.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h3 class="text-xl font-bold mb-2 md:mb-0">${tarefa.nome}</h3>
                        <p class="text-sm text-gray-600">${porcentagemConcluida.toFixed(1)}% concluído</p>
                    </div>
                    <div class="bg-gray-200 rounded-full h-2 mb-4">
                        <div class="bg-green-500 h-2 rounded-full" style="width: ${porcentagemConcluida}%;"></div>
                    </div>
                    <div class="flex flex-wrap justify-between items-center text-sm text-gray-600 mb-4">
                        <span>Metragem: ${metragemConcluida.toFixed(2)} / ${tarefa.metragemTotal.toFixed(2)}</span>
                        <span>Unidade: ${tarefa.unidade}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-500">Valor Unitário</p>
                            <p class="font-semibold">${formatCurrency(valorUnitario)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Valor Total</p>
                            <p class="font-semibold">${formatCurrency(tarefa.valorTotal)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Valor Medido</p>
                            <p class="font-semibold text-green-600">${formatCurrency(valorMedido)}</p>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button class="view-medicoes-btn btn btn-secondary btn-sm" data-id="${tarefa.id}">Ver Medições</button>
                        <button class="add-medicao-btn btn btn-primary btn-sm" data-id="${tarefa.id}">Add Medição</button>
                        <button class="edit-tarefa-btn btn btn-secondary btn-sm" data-id="${tarefa.id}">Editar</button>
                        <button class="delete-tarefa-btn btn btn-secondary btn-sm" data-id="${tarefa.id}">Excluir</button>
                    </div>
                `;
                tarefasList.appendChild(tarefaCard);
            });

            document.querySelectorAll('.view-medicoes-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
                    const tarefaDoc = await getDoc(tarefaDocRef);
                    const tarefa = tarefaDoc.data();
                    openMedicoesList(tarefaId, tarefa.medicoes || []);
                });
            });

            document.querySelectorAll('.add-medicao-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    openMedicaoForm(tarefaId);
                });
            });

            document.querySelectorAll('.edit-tarefa-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    const tarefa = tarefas.find(t => t.id === tarefaId);
                    openTarefaForm(tarefa);
                });
            });

            document.querySelectorAll('.delete-tarefa-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    openModal('Confirmação', `
                        <p class="text-center text-gray-700 mb-4">Tem certeza que deseja deletar esta tarefa?</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmDeleteBtn" class="btn btn-primary">Sim</button>
                            <button id="cancelDeleteBtn" class="btn btn-secondary">Não</button>
                        </div>
                    `);
                    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                        deleteTarefa(tarefaId);
                        closeModal();
                    });
                    document.getElementById('cancelDeleteBtn').addEventListener('click', closeModal);
                });
            });

            if (tarefas.length === 0) {
                tarefasList.innerHTML = '<p class="text-center text-gray-500">Nenhuma tarefa registrada para esta obra.</p>';
            }
        });
    };

    const openMedicaoForm = (tarefaId, medicao = {}, medicaoIndex = -1) => {
        const formHtml = `
            <form id="medicao-form" class="space-y-4">
                <div>
                    <label for="medicao-metragem" class="block text-sm font-medium text-gray-700">Metragem</label>
                    <input type="number" step="0.01" id="medicao-metragem" name="metragem" value="${medicao.metragem || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="medicao-valor" class="block text-sm font-medium text-gray-700">Valor</label>
                    <input type="number" step="0.01" id="medicao-valor" name="valor" value="${medicao.valor || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="medicao-data" class="block text-sm font-medium text-gray-700">Data</label>
                    <input type="date" id="medicao-data" name="data" value="${medicao.data || new Date().toISOString().split('T')[0]}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="medicao-observacoes" class="block text-sm font-medium text-gray-700">Observações</label>
                    <textarea id="medicao-observacoes" name="observacoes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${medicao.observacoes || ''}</textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">${medicaoIndex !== -1 ? 'Atualizar' : 'Adicionar'} Medição</button>
            </form>
        `;
        openModal(medicaoIndex !== -1 ? 'Editar Medição' : 'Adicionar Medição', formHtml);
        document.getElementById('medicao-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newMedicao = {
                metragem: parseFloat(formData.get('metragem')),
                valor: parseFloat(formData.get('valor')),
                data: formData.get('data'),
                observacoes: formData.get('observacoes')
            };
            if (medicaoIndex !== -1) {
                await updateMedicaoInTarefa(tarefaId, medicaoIndex, newMedicao);
            } else {
                await addMedicaoToTarefa(tarefaId, newMedicao);
            }
            closeModal();
        });
    };

    const openMedicoesList = (tarefaId, medicoes) => {
        let medicoesHtml = '<h4 class="text-xl font-semibold mb-4">Medições Registradas</h4>';
        if (medicoes.length === 0) {
            medicoesHtml += '<p class="text-center text-gray-500">Nenhuma medição para esta tarefa.</p>';
        } else {
            medicoesHtml += '<div class="space-y-4">';
            medicoes.forEach((medicao, index) => {
                medicoesHtml += `
                    <div class="medicoes-list-item card p-4 flex justify-between items-center">
                        <div>
                            <p class="font-semibold">Metragem: ${medicao.metragem.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">Valor: ${formatCurrency(medicao.valor)}</p>
                            <p class="text-sm text-gray-500">Data: ${new Date(medicao.data).toLocaleDateString()}</p>
                            ${medicao.observacoes ? `<p class="text-sm text-gray-600 mt-1">Obs: ${medicao.observacoes}</p>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-single-medicao-btn btn btn-secondary btn-sm" data-tarefa-id="${tarefaId}" data-index="${index}">Editar</button>
                            <button class="delete-single-medicao-btn btn btn-secondary btn-sm" data-tarefa-id="${tarefaId}" data-index="${index}">Excluir</button>
                        </div>
                    </div>
                `;
            });
            medicoesHtml += '</div>';
        }
        openModal('Medições da Tarefa', medicoesHtml);

        document.querySelectorAll('.edit-single-medicao-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tId = e.currentTarget.dataset.tarefaId;
                const mIndex = parseInt(e.currentTarget.dataset.index);
                const medicaoToEdit = medicoes[mIndex];
                closeModal(); // Fecha a lista de medições para abrir o formulário de edição
                openMedicaoForm(tId, medicaoToEdit, mIndex);
            });
        });

        document.querySelectorAll('.delete-single-medicao-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tId = e.currentTarget.dataset.tarefaId;
                const mIndex = parseInt(e.currentTarget.dataset.index);
                openModal('Confirmação', `
                    <p class="text-center text-gray-700 mb-4">Tem certeza que deseja deletar esta medição?</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirmDeleteMedicaoBtn" class="btn btn-primary">Sim</button>
                        <button id="cancelDeleteMedicaoBtn" class="btn btn-secondary">Não</button>
                    </div>
                `);
                document.getElementById('confirmDeleteMedicaoBtn').addEventListener('click', () => {
                    deleteMedicao(tId, mIndex);
                    closeModal();
                });
                document.getElementById('cancelDeleteMedicaoBtn').addEventListener('click', closeModal);
            });
        });
    };

    // Renderização do Cronograma (Gantt)
    const renderCronograma = async () => {
  if (!currentObraId) return;

  // Limpa o gráfico Gantt existente
  ganttChart.innerHTML = '';
  ganttTasks = [];

  const cronogramaDoc = await getCronograma();
  const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
  const snapshot = await getDocs(tarefasRef);
  const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  const dias = parseInt(cronogramaDias.value) || 30;

  // Cria cabeçalho de dias
  const headerRow = document.createElement('div');
  headerRow.className = 'gantt-row';
  headerRow.innerHTML = '<div class="gantt-row-label gantt-header">Tarefa</div>';
  for (let i = 1; i <= dias; i++) {
    headerRow.innerHTML += `<div class="gantt-header">${i}</div>`;
  }
  ganttChart.appendChild(headerRow);

  // Cria linhas para cada tarefa
  tarefas.forEach(tarefa => {
    const row = document.createElement('div');
    row.className = 'gantt-row';
    row.dataset.id = tarefa.id;
    row.style.display = 'contents'; // Permite que os filhos se posicionem no grid

    const labelCell = document.createElement('div');
    labelCell.className = 'gantt-row-label';
    labelCell.textContent = tarefa.nome;
    row.appendChild(labelCell);

    for (let i = 1; i <= dias; i++) {
      const cell = document.createElement('div');
      cell.className = 'gantt-day-cell';
      row.appendChild(cell);
    }
    ganttChart.appendChild(row);

    // Adiciona inputs para start e duration
    const startDay = (tarefa.cronograma && tarefa.cronograma.start) ? tarefa.cronograma.start : 1;
    const duration = (tarefa.cronograma && tarefa.cronograma.duration) ? tarefa.cronograma.duration : 5;

    const startInput = document.createElement('input');
    startInput.type = 'number';
    startInput.value = startDay;
    startInput.min = '1';
    startInput.className = 'task-start-input w-16 text-center border rounded-md text-black';
    startInput.dataset.id = tarefa.id;
    labelCell.appendChild(startInput);

    const durationInput = document.createElement('input');
    durationInput.type = 'number';
    durationInput.value = duration;
    durationInput.min = '1';
    durationInput.className = 'task-duration-input w-16 text-center border rounded-md text-black ml-2';
    durationInput.dataset.id = tarefa.id;
    labelCell.appendChild(durationInput);

    ganttTasks.push({
      id: tarefa.id,
      name: tarefa.nome,
      start: startDay,
      end: startDay + duration - 1,
      duration: duration,
      valorTotal: tarefa.valorTotal || 0,
      medicoes: tarefa.medicoes || []
    });
  });

  // Adiciona listeners aos inputs de start/duration
  document.querySelectorAll('.task-start-input, .task-duration-input').forEach(input => {
    input.addEventListener('change', async (e) => {
      const id = e.currentTarget.dataset.id;
      const startInput = document.querySelector(`.task-start-input[data-id="${id}"]`);
      const durInput = document.querySelector(`.task-duration-input[data-id="${id}"]`);
      const newStart = Math.max(1, parseInt(startInput.value) || 1);
      const newDuration = Math.max(1, parseInt(durInput.value) || 1);
      // Atualiza ganttTasks
      const task = ganttTasks.find(t => t.id === id);
      if (task) {
        task.start = newStart;
        task.duration = newDuration;
        task.end = newStart + newDuration - 1;
      }
      // Salva cronograma no Firestore (dentro do documento da tarefa)
      const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, id);
      await updateDoc(tarefaDocRef, { cronograma: { start: newStart, duration: newDuration } });
      renderGanttBars();
      renderCurvaS(ganttTasks);
    });
  });

  renderGanttBars();
  renderCurvaS(ganttTasks);
};


const renderGanttBars = () => {
  document.querySelectorAll(".gantt-task-bar").forEach(b => b.remove());
  const firstCell = document.querySelector(".gantt-day-cell");
  if (!firstCell) return;
  const cellWidth = firstCell.offsetWidth;

  ganttTasks.forEach(task => {
    const row = document.querySelector(`.gantt-row[data-id='${task.id}']`);
    if (!row) return;
    const rowCells = row.querySelectorAll(".gantt-day-cell");
    const rowTop = rowCells[0].offsetTop;
    const barLeft = (task.start - 1) * cellWidth;
    const barWidth = task.duration * cellWidth;

    const bar = document.createElement("div");
    bar.className = "gantt-task-bar";
    bar.dataset.taskId = task.id;
    bar.style.top = rowTop + "px";
    bar.style.left = barLeft + "px";
    bar.style.width = barWidth + "px";
    bar.innerHTML = `
      <div class="gantt-task-handle gantt-task-handle-left"></div>
      <div class="gantt-task-handle gantt-task-handle-right"></div>
      <span style="padding:0 6px;">${task.name}</span>
    `;
    ganttChart.appendChild(bar);
    bar.addEventListener("mousedown", startDrag);
  });
};

const startDrag = (e) => {
  e.preventDefault();
  isDragging = true;
  currentDragElement = e.target.closest(".gantt-task-bar");
  dragStartX = e.clientX;
  const taskId = currentDragElement.dataset.taskId;
  const task = ganttTasks.find(t => t.id === taskId);
  originalStartDay = task.start;
  originalEndDay = task.end;
  dragType = e.target.classList.contains("gantt-task-handle-left")
    ? "resize-left"
    : e.target.classList.contains("gantt-task-handle-right")
    ? "resize-right"
    : "move";
  document.addEventListener("mousemove", handleDrag);
  document.addEventListener("mouseup", stopDrag);
};

const handleDrag = (e) => {
  if (!isDragging || !currentDragElement) return;
  const firstCell = document.querySelector(".gantt-day-cell");
  if (!firstCell) return;
  const cellWidth = firstCell.offsetWidth;
  const deltaX = e.clientX - dragStartX;
  const deltaDays = Math.round(deltaX / cellWidth);
  const taskId = currentDragElement.dataset.taskId;
  const task = ganttTasks.find(t => t.id === taskId);

  if (!task) return;

  if (dragType === "move") {
    const newStart = Math.max(1, originalStartDay + deltaDays);
    task.start = newStart;
    task.end = newStart + task.duration - 1;
  } else if (dragType === "resize-left") {
    const newStart = Math.max(1, Math.min(originalStartDay + deltaDays, task.end - 1));
    task.start = newStart;
    task.duration = task.end - newStart + 1;
  } else if (dragType === "resize-right") {
    const newEnd = Math.max(task.start, originalEndDay + deltaDays);
    task.end = newEnd;
    task.duration = newEnd - task.start + 1;
  }
  renderGanttBars();
};

const stopDrag = async () => {
  if (!isDragging) return;
  isDragging = false;
  // Ao soltar, salva alterações no Firestore (no documento da tarefa)
  const cronogramaData = {};
  const updates = [];
  ganttTasks.forEach(t => {
    cronogramaData[t.id] = { start: t.start, end: t.end, duration: t.duration };
    // prepara atualização por tarefa
    const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, t.id);
    updates.push(updateDoc(tarefaDocRef, { cronograma: { start: t.start, duration: t.duration } }));
  });
  try {
    await Promise.all(updates);
  } catch (err) {
    console.error("Erro ao salvar cronograma:", err);
  }
  document.removeEventListener("mousemove", handleDrag);
  document.removeEventListener("mouseup", stopDrag);
};


// --- RENDER CURVA S ---

const renderCurvaS = (tarefasInput) => {
  const ctx = document.getElementById('curva-s-chart').getContext('2d');

  // Interpret input: tarefasInput can be either array of tarefas from Firestore
  // or our ganttTasks (which include start/duration/valorTotal/medicoes)
  const dias = parseInt(cronogramaDias.value) || 30;
  let planejado = Array(dias).fill(0);
  let realizado = Array(dias).fill(0);

  // Build planejado distribuindo valorTotal por dia de cada tarefa
  tarefasInput.forEach(t => {
    const start = t.start || 1;
    const duration = t.duration || (t.prazo || 5);
    const valor = t.valorTotal || 0;
    const valorDia = valor / Math.max(1, duration);
    for (let d = start; d < start + duration && d <= dias; d++) {
      planejado[d-1] += valorDia;
    }
    // Process medicoes no formato armazenado nas tarefas (se houver)
    const medicoes = t.medicoes || t.medicoes || [];
    medicoes.forEach(m => {
      if (!m || !m.data) return;
      const medDate = new Date(m.data);
      const hoje = new Date();
      // calcula diferença em dias entre hoje e data da medição (positivo se medição em futuro)
      const diffDays = Math.floor((medDate - hoje) / (1000*60*60*24));
      const idx = diffDays >= 0 && diffDays < dias ? diffDays : null;
      // Se medição for histórica (<= hoje), vamos tentar mapear para os últimos dias: usar diferença negativa -> mapear ao dia 1..dias
      if (idx !== null) {
        realizado[idx] += m.valor || 0;
      } else {
        // alternativa: se a data está entre hoje - (dias-1) e hoje, considerar retroativo
        const diffFromStart = Math.floor((medDate - hoje) / (1000*60*60*24));
        // Não adicionar se for muito fora do range
      }
    });
  });

  // Acumula valores
  for (let i=1; i<dias; i++) {
    planejado[i] += planejado[i-1];
    realizado[i] += realizado[i-1];
  }

  const labels = Array.from({length: dias}, (_, i) => {
    const date = new Date();
    date.setDate(date.getDate() + i);
    return date.toLocaleDateString("pt-BR", { day: "2-digit", month: "short" });
  });

  if (curvaSChart) curvaSChart.destroy();

  curvaSChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Planejado',
          data: planejado,
          borderColor: 'blue',
          fill: false
        },
        {
          label: 'Realizado',
          data: realizado,
          borderColor: 'green',
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        y: {
          title: { display: true, text: 'R$ Acumulado' }
        }
      }
    }
  });
};


// Renderização de Despesas

    const renderDespesas = () => {
        if (!currentObraId) return;
        const despesasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/despesas`);
        onSnapshot(despesasRef, (snapshot) => {
            despesasList.innerHTML = '';
            const despesas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            let total = 0;
            let maiorDespesa = 0;
            
            despesas.forEach(despesa => {
                total += despesa.valor;
                if (despesa.valor > maiorDespesa) {
                    maiorDespesa = despesa.valor;
                }
            
                const despesaItem = document.createElement('div');
                despesaItem.className = 'despesa-item';
                despesaItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${despesa.descricao}</p>
                            <p class="text-sm text-gray-500">${new Date(despesa.data).toLocaleDateString()} - ${despesa.categoria}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-red-600 font-bold">${formatCurrency(despesa.valor)}</p>
                            <div class="flex space-x-2 mt-2">
                                <button class="edit-despesa-btn text-gray-500 hover:text-gray-700" data-id="${despesa.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5.5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293zM14.707 5.293a1 1 0 011.414 0l1.586 1.586a1 1 0 010 1.414l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5.5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293z"></path>
                                    </svg>
                                </button>
                                <button class="delete-despesa-btn text-gray-500 hover:text-gray-700" data-id="${despesa.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                despesasList.appendChild(despesaItem);
            });
            
            // Atualizar totais
            document.getElementById('total-despesas').textContent = formatCurrency(total);
            document.getElementById('maior-despesa').textContent = formatCurrency(maiorDespesa);
            
            // Calcular média por dia (considerando últimos 30 dias)
            const media = total / 30;
            document.getElementById('media-despesas').textContent = formatCurrency(media);
            
            // Adicionar event listeners para editar e excluir
            document.querySelectorAll('.edit-despesa-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const despesaId = e.currentTarget.dataset.id;
                    const despesa = despesas.find(d => d.id === despesaId);
                    openDespesaForm(despesa);
                });
            });
            document.querySelectorAll('.delete-despesa-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const despesaId = e.currentTarget.dataset.id;
                    openModal('Confirmação', `
                        <p class="text-center text-gray-700 mb-4">Tem certeza que deseja deletar esta despesa?</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmDeleteBtn" class="btn btn-primary">Sim</button>
                            <button id="cancelDeleteBtn" class="btn btn-secondary">Não</button>
                        </div>
                    `);
                    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                        deleteDespesa(despesaId);
                        closeModal();
                    });
                    document.getElementById('cancelDeleteBtn').addEventListener('click', closeModal);
                });
            });
            
            // Se não houver despesas, mostrar mensagem
            if (despesas.length === 0) {
                despesasList.innerHTML = '<p class="text-center text-gray-500">Nenhuma despesa registrada.</p>';
            }
        });
    };

    const renderRelatorios = async () => {
        if (!currentObraId) {
            relatorioContent.innerHTML = '<p class="text-center text-gray-600">Selecione uma obra na aba "Obras" para visualizar os relatórios.</p>';
            return;
        }

        const obraDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, currentObraId);
        const obraDoc = await getDoc(obraDocRef);
        const obra = obraDoc.data();

        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        const snapshot = await getDocs(tarefasRef);
        const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        let totalTarefas = tarefas.length;
        let totalConcluidas = tarefas.filter(t => (t.medicoes || []).reduce((sum, m) => sum + (m.valor || 0), 0) >= t.valorTotal).length;
        let valorMedidoTotal = tarefas.reduce((sum, t) => sum + (t.medicoes || []).reduce((sum, m) => sum + (m.valor || 0), 0), 0);
        let progressoGeral = calculatePercentage(valorMedidoTotal, obra.valorTotal);

        relatorioContent.innerHTML = `
            <h3 class="text-xl font-semibold mb-4">Relatório Geral da Obra</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="p-6 bg-gray-100 rounded-lg">
                    <p class="text-gray-500">Total de Tarefas</p>
                    <p class="text-3xl font-bold">${totalTarefas}</p>
                    <p class="text-sm text-gray-500">${totalConcluidas} concluídas</p>
                </div>
                <div class="p-6 bg-gray-100 rounded-lg">
                    <p class="text-gray-500">Valor Total Medido</p>
                    <p class="text-3xl font-bold text-green-600">${formatCurrency(valorMedidoTotal)}</p>
                    <p class="text-sm text-gray-500">de ${formatCurrency(obra.valorTotal)} total</p>
                </div>
                <div class="p-6 bg-gray-100 rounded-lg">
                    <p class="text-gray-500">Progresso Geral</p>
                    <p class="text-3xl font-bold">${progressoGeral.toFixed(1)}%</p>
                    <p class="text-sm text-gray-500">média das tarefas</p>
                </div>
            </div>

            <hr class="my-8">

            <h3 class="text-xl font-semibold mb-4 flex items-center justify-between">
                Relatório por Período
                <button id="read-summary-btn" class="btn btn-primary ml-4">Ouvir Resumo ✨</button>
            </h3>
            <div class="space-y-4">
                <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-4 md:space-y-0">
                    <div class="flex-1">
                        <label for="start-date" class="block text-sm font-medium text-gray-700">Data de Início</label>
                        <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div class="flex-1">
                        <label for="end-date" class="block text-sm font-medium text-gray-700">Data de Fim</label>
                        <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <button id="generate-period-report-btn" class="btn btn-primary">Gerar Relatório</button>
                </div>
                <div id="period-report-result" class="mt-6">
                    </div>
            </div>
        `;
        const generateBtn = document.getElementById('generate-period-report-btn');
        generateBtn.addEventListener('click', () => {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            generatePeriodReport(startDate, endDate);
        });

        document.getElementById('read-summary-btn').addEventListener('click', async () => {
            const summaryText = `
                Relatório geral da obra. Total de tarefas: ${totalTarefas}, sendo ${totalConcluidas} concluídas. 
                Valor total medido: ${formatCurrency(valorMedidoTotal)}, de um total de ${formatCurrency(obra.valorTotal)}. 
                Progresso geral: ${progressoGeral.toFixed(1)} por cento.
            `;
            // await speakText(summaryText);
            openModal('Resumo do Relatório', `<p class="text-center text-gray-700">${summaryText}</p><p class="text-center text-gray-700 mt-2">Funcionalidade de áudio desativada no momento.</p>`);
        });
    };

    const generatePeriodReport = async (startDateStr, endDateStr) => {
        const reportResultDiv = document.getElementById('period-report-result');
        reportResultDiv.innerHTML = '<p class="text-center text-gray-600">Gerando relatório...</p>';

        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        endDate.setHours(23, 59, 59, 999); // Incluir o dia inteiro

        const obraDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, currentObraId);
        const obraDoc = await getDoc(obraDocRef);
        const obra = obraDoc.data();
        const nomeObra = obra.nome;

        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        const snapshot = await getDocs(tarefasRef);
        const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        let relatorioHtml = '';
        let totalPeriodo = 0;
        let hasData = false;
        const reportData = []; // Para exportação
        const taskTotals = {}; // Para exportação

        tarefas.forEach(tarefa => {
            const medicoesPeriodo = (tarefa.medicoes || []).filter(medicao => {
                const medicaoDate = new Date(medicao.data);
                return medicaoDate >= start && medicaoDate < end;
            });

            if (medicoesPeriodo.length > 0) {
                hasData = true;
                const valorPeriodoTarefa = medicoesPeriodo.reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
                totalPeriodo += valorPeriodoTarefa;
                
                if (!taskTotals[tarefa.nome]) {
                    taskTotals[tarefa.nome] = 0;
                }
                taskTotals[tarefa.nome] += valorPeriodoTarefa;


                relatorioHtml += `
                    <div class="card p-4 mb-4">
                        <p class="font-semibold text-lg">${tarefa.nome}</p>
                        <p class="text-sm text-gray-500 mb-2">Medições realizadas no período:</p>
                        <ul class="list-disc list-inside space-y-1">
                            ${medicoesPeriodo.map(m => {
                                const medicaoInfo = `Metragem: ${m.metragem.toFixed(2)} ${tarefa.unidade} - ${formatCurrency(m.valor)} em ${new Date(m.data).toLocaleDateString()}`;
                                reportData.push({
                                    'Tarefa': tarefa.nome,
                                    'Metragem': m.metragem,
                                    'Unidade': tarefa.unidade,
                                    'Valor': m.valor,
                                    'Data': new Date(m.data).toLocaleDateString(),
                                    'Observacoes': m.observacoes || ''
                                });
                                return `<li>${medicaoInfo}</li>`;
                            }).join('')}
                        </ul>
                        <div class="mt-2 text-sm">
                            <p class="font-bold">Total Medido nesta tarefa: <span class="text-green-600">${formatCurrency(valorPeriodoTarefa)}</span></p>
                        </div>
                    </div>
                `;
            }
        });

        if (!hasData) {
            reportResultDiv.innerHTML = '<p class="text-center text-gray-600">Nenhuma medição encontrada no período selecionado.</p>';
        } else {
            reportResultDiv.innerHTML = `
                <div class="p-6 bg-gray-200 rounded-lg mb-6 flex flex-col md:flex-row justify-between items-center">
                    <div>
                        <p class="text-gray-600 font-bold text-xl">Total a Receber no Período:</p>
                        <p class="text-4xl font-extrabold text-green-700 mt-2">${formatCurrency(totalPeriodo)}</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex space-x-2">
                        <button id="export-pdf-btn" class="btn btn-secondary">Exportar PDF</button>
                        <button id="export-excel-btn" class="btn btn-secondary">Exportar Excel</button>
                    </div>
                </div>
                ${relatorioHtml}
            `;
            document.getElementById('export-pdf-btn').addEventListener('click', () => {
                exportPDF(reportData, taskTotals, nomeObra, startDate, endDate, totalPeriodo);
            });
            document.getElementById('export-excel-btn').addEventListener('click', () => {
                exportExcel(reportData, taskTotals, nomeObra, startDate, endDate, totalPeriodo);
            });
        }
    };

    const exportPDF = (data, taskTotals, nomeObra, startDate, endDate, total) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text(`Relatório de Medições - ${nomeObra}`, 14, 22);

        doc.setFontSize(12);
        doc.text(`Período: ${new Date(startDate).toLocaleDateString()} a ${new Date(endDate).toLocaleDateString()}`, 14, 30);
        doc.text(`Total a Receber: ${formatCurrency(total)}`, 14, 38);
        // First table: detailed report
        const columns = ["Tarefa", "Metragem", "Unidade", "Valor (R$)", "Data", "Observações"];
        const rows = data.map(item => [
            item.Tarefa,
            item.Metragem.toFixed(2),
            item.Unidade,
            item.Valor.toFixed(2),
            item.Data,
            item.Observacoes
        ]);
        doc.autoTable({
            head: [columns],
            body: rows,
            startY: 45
        });
        // Second table: task totals
        const taskTotalColumns = ["Tarefa", "Total a Receber"];
        const taskTotalRows = Object.keys(taskTotals).map(taskName => [
            taskName,
            formatCurrency(taskTotals[taskName])
        ]);
        doc.autoTable({
            head: [taskTotalColumns],
            body: taskTotalRows,
            startY: doc.autoTable.previous.finalY + 10,
            theme: 'striped',
            headStyles: { fillColor: [52, 58, 64] },
            bodyStyles: { textColor: [33, 37, 41] },
        });
        doc.save(`relatorio_${nomeObra}_${startDate}_${endDate}.pdf`);
    };

    const exportExcel = (data, taskTotals, nomeObra, startDate, endDate, total) => {
        // Prepare detailed data
        const detailedData = [
            ["Relatório de Medições"],
            [`Obra: ${nomeObra}`],
            [`Período: ${new Date(startDate).toLocaleDateString()} a ${new Date(endDate).toLocaleDateString()}`],
            [`Total a Receber: ${formatCurrency(total)}`],
            [],
            ["Relatório Detalhado"],
            ["Tarefa", "Metragem", "Unidade", "Valor (R$)", "Data", "Observações"]
        ].concat(data.map(item => [
            item.Tarefa,
            item.Metragem,
            item.Unidade,
            item.Valor,
            item.Data,
            item.Observacoes
        ]));
        // Prepare task totals data
        const taskTotalData = [
            [],
            [],
            ["Totais por Tarefa"],
            ["Tarefa", "Total a Receber"]
        ].concat(Object.keys(taskTotals).map(taskName => [
            taskName,
            taskTotals[taskName]
        ]));

        const worksheet = XLSX.utils.aoa_to_sheet(detailedData.concat(taskTotalData));
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Relatorio");
        XLSX.writeFile(workbook, `relatorio_${nomeObra}_${startDate}_${endDate}.xlsx`);
    };

    // Forms
    const openObraForm = (obra = {}) => {
        const formHtml = `
            <form id="obra-form" class="space-y-4">
                <div>
                    <label for="obra-nome" class="block text-sm font-medium text-gray-700">Nome da Obra</label>
                    <input type="text" id="obra-nome" name="nome" value="${obra.nome || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                </div>
                <div>
                    <label for="obra-localizacao" class="block text-sm font-medium text-gray-700">Localização</label>
                    <input type="text" id="obra-localizacao" name="localizacao" value="${obra.localizacao || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                </div>
                <div>
                    <label for="obra-valor" class="block text-sm font-medium text-gray-700">Valor Total (R$)</label>
                    <input type="number" id="obra-valor" name="valorTotal" value="${obra.valorTotal || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">${obra.id ? 'Atualizar' : 'Salvar'}</button>
            </form>
        `;
        openModal(obra.id ? 'Editar Obra' : 'Nova Obra', formHtml);
        document.getElementById('obra-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newObra = {
                nome: formData.get('nome'),
                localizacao: formData.get('localizacao'),
                valorTotal: parseFloat(formData.get('valorTotal')),
                valorMedido: obra.valorMedido || 0
            };
            addOrUpdateObra({ ...newObra, id: obra.id });
        });
    };
    
    const openTarefaForm = (tarefa = {}) => {
        const formHtml = `
            <form id="tarefa-form" class="space-y-4">
                <div>
                    <label for="tarefa-nome" class="block text-sm font-medium text-gray-700">Nome da Tarefa</label>
                    <input type="text" id="tarefa-nome" name="nome" value="${tarefa.nome || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-metragem-total" class="block text-sm font-medium text-gray-700">Metragem Total</label>
                    <input type="number" step="0.01" id="tarefa-metragem-total" name="metragemTotal" value="${tarefa.metragemTotal || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-unidade" class="block text-sm font-medium text-gray-700">Unidade (m, un, etc.)</label>
                    <input type="text" id="tarefa-unidade" name="unidade" value="${tarefa.unidade || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-valor-total" class="block text-sm font-medium text-gray-700">Valor Total</label>
                    <input type="number" step="0.01" id="tarefa-valor-total" name="valorTotal" value="${tarefa.valorTotal || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="tarefa-descricao" name="descricao" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${tarefa.descricao || ''}</textarea>
                    <button type="button" id="gerar-descricao-btn" class="btn btn-secondary mt-2">Gerar Descrição ✨</button>
                </div>
                <button type="submit" class="btn btn-primary w-full">${tarefa.id ? 'Atualizar' : 'Salvar'}</button>
            </form>
        `;
        openModal(tarefa.id ? 'Editar Tarefa' : 'Nova Tarefa', formHtml);
        document.getElementById('tarefa-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const metragemTotal = parseFloat(formData.get('metragemTotal'));
            const valorTotal = parseFloat(formData.get('valorTotal'));
            const valorUnitario = metragemTotal > 0 ? (valorTotal / metragemTotal) : 0;
            const newTarefa = {
                nome: formData.get('nome'),
                metragemTotal: metragemTotal,
                unidade: formData.get('unidade'),
                valorUnitario: valorUnitario,
                valorTotal: valorTotal,
                descricao: formData.get('descricao'),
                medicoes: tarefa.medicoes || []
            };
            addOrUpdateTarefa({ ...newTarefa, id: tarefa.id });
        });
        document.getElementById('gerar-descricao-btn').addEventListener('click', () => {
            const nome = document.getElementById('tarefa-nome').value;
            const unidade = document.getElementById('tarefa-unidade').value;
            if (nome && unidade) {
                generateTaskDescription(nome, unidade);
            } else {
                openModal('Atenção', 'Por favor, preencha o nome da tarefa e a unidade primeiro.');
            }
        });
    };

    // Formulário para Despesas
    const openDespesaForm = (despesa = {}) => {
        const formHtml = `
            <form id="despesa-form" class="space-y-4">
                <div>
                    <label for="despesa-descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <input type="text" id="despesa-descricao" name="descricao" value="${despesa.descricao || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="despesa-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                    <input type="number" step="0.01" id="despesa-valor" name="valor" value="${despesa.valor || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="despesa-data" class="block text-sm font-medium text-gray-700">Data</label>
                    <input type="date" id="despesa-data" name="data" value="${despesa.data || new Date().toISOString().split('T')[0]}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="despesa-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="despesa-categoria" name="categoria" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        <option value="Gasolina" ${despesa.categoria === 'Gasolina' ? 'selected' : ''}>Gasolina</option>
                        <option value="Alimentação" ${despesa.categoria === 'Alimentação' ? 'selected' : ''}>Alimentação</option>
                        <option value="Hospedagem" ${despesa.categoria === 'Hospedagem' ? 'selected' : ''}>Hospedagem</option>
                        <option value="Materiais" ${despesa.categoria === 'Materiais' ? 'selected' : ''}>Materiais</option>
                        <option value="Outros" ${despesa.categoria === 'Outros' ? 'selected' : ''}>Outros</option>
                    </select>
                </div>
                <div>
                    <label for="despesa-observacoes" class="block text-sm font-medium text-gray-700">Observações</label>
                    <textarea id="despesa-observacoes" name="observacoes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${despesa.observacoes || ''}</textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">${despesa.id ? 'Atualizar' : 'Salvar'}</button>
            </form>
        `;
        openModal(despesa.id ? 'Editar Despesa' : 'Nova Despesa', formHtml);
        document.getElementById('despesa-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newDespesa = {
                descricao: formData.get('descricao'),
                valor: parseFloat(formData.get('valor')),
                data: formData.get('data'),
                categoria: formData.get('categoria'),
                observacoes: formData.get('observacoes')
            };
            addOrUpdateDespesa({ ...newDespesa, id: despesa.id });
        });
    };

    // LLM - Gerador de Descrição de Tarefa
    const generateTaskDescription = async (nome, unidade) => {
        const descricaoTextarea = document.getElementById('tarefa-descricao');
        const generateBtn = document.getElementById('gerar-descricao-btn');
        const originalBtnText = generateBtn.textContent;
        generateBtn.disabled = true;
        generateBtn.textContent = 'Gerando...';
        const prompt = `Gere uma descrição concisa e profissional para uma tarefa de engenharia de combate a incêndio. O nome da tarefa é "${nome}" e a unidade de medição é "${unidade}". A descrição deve ser focada em detalhes técnicos relevantes para a medição da obra, como "Instalação da tubulação principal de 4 polegadas. A medição será por metro linear (m)."`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
        };
        try {
            const response = await fetch(`${GEMINI_API_URL_GENERATE}${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (data.candidates && data.candidates.length > 0) {
                descricaoTextarea.value = data.candidates[0].content.parts[0].text;
            } else {
                openModal('Erro na Geração', 'Não foi possível gerar a descrição. Tente novamente.');
            }
        } catch (error) {
            console.error('Erro ao gerar descrição:', error);
            openModal('Erro na Geração', `Ocorreu um erro ao gerar a descrição: ${error.message}`);
        } finally {
            generateBtn.disabled = false;
            generateBtn.textContent = originalBtnText;
        }
    };

    // Renderização de Relatório de Despesas por Período
    const generateDespesaPeriodReport = async (startDateStr, endDateStr) => {
        const reportResultDiv = document.getElementById('despesa-period-report-result');
        reportResultDiv.innerHTML = '<p class="text-center text-gray-600">Gerando relatório de despesas...</p>';

        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        endDate.setHours(23, 59, 59, 999); // Incluir o dia inteiro

        const despesasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/despesas`);
        const q = query(despesasRef, where("data", ">=", startDateStr), where("data", "<=", endDateStr));
        const snapshot = await getDocs(q);
        const despesas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        let relatorioHtml = '';
        let totalPeriodo = 0;
        const porCategoria = {};

        despesas.forEach(despesa => {
            totalPeriodo += despesa.valor;
            if (!porCategoria[despesa.categoria]) {
                porCategoria[despesa.categoria] = 0;
            }
            porCategoria[despesa.categoria] += despesa.valor;
        });

        document.getElementById('relatorio-despesas-container').classList.remove('hidden');

        relatorioHtml = `
            <div class="p-6 bg-gray-200 rounded-lg mb-6 flex flex-col md:flex-row justify-between items-center">
                <div>
                    <p class="text-gray-600 font-bold text-xl">Total de Despesas no Período:</p>
                    <p class="text-4xl font-extrabold text-red-700 mt-2">${formatCurrency(totalPeriodo)}</p>
                </div>
                <div class="mt-4 md:mt-0 flex space-x-2">
                    <button id="export-despesa-pdf-btn" class="btn btn-secondary">Exportar PDF</button>
                    <button id="export-despesa-excel-btn" class="btn btn-secondary">Exportar Excel</button>
                </div>
            </div>
            <h4 class="text-lg font-semibold mb-4">Por Categoria</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        `;
        Object.keys(porCategoria).forEach(categoria => {
            relatorioHtml += `
                <div class="p-4 bg-gray-100 rounded-lg">
                    <p class="text-gray-500">${categoria}</p>
                    <p class="text-2xl font-bold">${formatCurrency(porCategoria[categoria])}</p>
                </div>
            `;
        });
        relatorioHtml += `</div><h4 class="text-lg font-semibold mb-4">Detalhamento</h4>`;
        
        despesas.forEach(despesa => {
            relatorioHtml += `
                <div class="despesa-item mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${despesa.descricao}</p>
                            <p class="text-sm text-gray-500">${new Date(despesa.data).toLocaleDateString()} - ${despesa.categoria}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-red-600 font-bold">${formatCurrency(despesa.valor)}</p>
                        </div>
                    </div>
                    ${despesa.observacoes ? `<p class="text-sm text-gray-600 mt-2">${despesa.observacoes}</p>` : ''}
                </div>
            `;
        });
        reportResultDiv.innerHTML = relatorioHtml;
        
        // Adicionar event listeners para os botões de exportação
        document.getElementById('export-despesa-pdf-btn').addEventListener('click', () => {
            exportDespesaPDF(despesas, porCategoria, startDate, endDate, totalPeriodo);
        });
        document.getElementById('export-despesa-excel-btn').addEventListener('click', () => {
            exportDespesaExcel(despesas, porCategoria, startDate, endDate, totalPeriodo);
        });
    };

    const exportDespesaPDF = (despesas, porCategoria, startDate, endDate, total) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text(`Relatório de Despesas`, 14, 22);
        
        doc.setFontSize(12);
        doc.text(`Período: ${new Date(startDate).toLocaleDateString()} a ${new Date(endDate).toLocaleDateString()}`, 14, 30);
        doc.text(`Total de Despesas: ${formatCurrency(total)}`, 14, 38);
        
        // Tabela de totais por categoria
        const categoriaColumns = ["Categoria", "Total"];
        const categoriaRows = Object.keys(porCategoria).map(cat => [cat, formatCurrency(porCategoria[cat])]);
        
        doc.autoTable({
            head: [categoriaColumns],
            body: categoriaRows,
            startY: 45
        });
        // Tabela detalhada
        const columns = ["Descrição", "Categoria", "Valor (R$)", "Data", "Observações"];
        const rows = despesas.map(d => [
            d.descricao,
            d.categoria,
            d.valor.toFixed(2),
            new Date(d.data).toLocaleDateString(),
            d.observacoes || ''
        ]);
        doc.autoTable({
            head: [columns],
            body: rows,
            startY: doc.autoTable.previous.finalY + 10,
            theme: 'striped',
            headStyles: { fillColor: [52, 58, 64] },
            bodyStyles: { textColor: [33, 37, 41] },
        });
        doc.save(`relatorio_despesas_${startDate}_${endDate}.pdf`);
    };

    const exportDespesaExcel = (despesas, porCategoria, startDate, endDate, total) => {
        // Preparar dados para exportação
        const data = [
            ["Relatório de Despesas"],
            [`Período: ${new Date(startDate).toLocaleDateString()} a ${new Date(endDate).toLocaleDateString()}`],
            [`Total de Despesas: ${formatCurrency(total)}`],
            [],
            ["Totais por Categoria"],
            ["Categoria", "Total"]
        ];
        Object.keys(porCategoria).forEach(cat => {
            data.push([cat, porCategoria[cat]]);
        });
        data.push([], [], ["Despesas Detalhadas"]);
        data.push(["Descrição", "Categoria", "Valor (R$)", "Data", "Observações"]);
        despesas.forEach(d => {
            data.push([
                d.descricao,
                d.categoria,
                d.valor,
                new Date(d.data).toLocaleDateString(),
                d.observacoes || ''
            ]);
        });
        const worksheet = XLSX.utils.aoa_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Relatorio Despesas");
        XLSX.writeFile(workbook, `relatorio_despesas_${startDate}_${endDate}.xlsx`);
    };

    // Event listeners for main buttons
    addObraBtn.addEventListener('click', () => openObraForm());
    addTarefaBtn.addEventListener('click', () => {
        if (!currentObraId) {
            openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
            return;
        }
        openTarefaForm();
    });
    addTarefaCronogramaBtn.addEventListener('click', () => {
        if (!currentObraId) {
            openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
            return;
        }
        openTarefaForm();
    });
    gerarCronogramaBtn.addEventListener('click', () => {
        if (!currentObraId) {
            openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
            return;
        }
        renderCronograma();
    });
    addDespesaBtn.addEventListener('click', () => {
        if (!currentObraId) {
            openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
            return;
        }
        openDespesaForm();
    });

    // Run app
    initFirebase();
</script>
</body>
</html>

