<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medições PPCI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: url('https://i.ibb.co/Kz2Bk089/Apresenta-o-Casa-Castilho-17-Editado.png') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
            color: #000;
        }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #E21B2F;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #c7172a;
        }
        .btn-secondary {
            background-color: #e9ecef;
            color: #495057;
        }
        .btn-secondary:hover {
            background-color: #dee2e6;
        }
        .tab-btn {
            flex-grow: 1;
            padding: 1rem;
            border-radius: 9999px;
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
        }
        .tab-btn.active {
            background-color: #494C4F;
            color: #fff;
        }
        input[type="text"], input[type="number"], input[type="date"], textarea {
            color: #000;
        }
        .medicoes-list-item {
            color: #000;
        }
        .gantt-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.css">
</head>
<body>

<div id="app" class="container">
    <!-- Header -->
    <div id="header-container" class="flex items-center justify-between mb-8 flex-wrap">
        <div class="flex items-center space-x-4 mb-4 md:mb-0">
            <img src="https://storage.googleapis.com/ecdt-logo-saida/721cb85e8ac2d398795a63e738d194fd4ab80aca16543ac9858e119ba5215aa7/CASA-CASTILHO-COM-DE-EXTINTORES-E-EQUIPAMENTOS-DE-SEGUR.webp" alt="Logo" class="w-20 h-20">
            <div>
                <h1 class="text-3xl font-bold text-white">Medições PPCI</h1>
                <p class="text-white">Sistema de Gestão de Obras</p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <span class="text-white">ID: <span id="userIdDisplay" class="font-mono"></span></span>
            <button id="logout-btn" class="btn btn-secondary">Sair</button>
        </div>
    </div>
    
    <!-- Login/Main Content -->
    <div id="main-content">
        <!-- Login Page (Default View) -->
        <div id="login-view" class="card">
            <h2 class="text-2xl font-semibold mb-4 text-center">Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="login-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <button type="submit" id="login-btn" class="btn btn-primary w-full">Entrar</button>
                <button type="button" id="create-account-btn" class="btn btn-secondary w-full">Criar Conta</button>
            </form>
        </div>

        <!-- App Main Content (hidden by default) -->
        <div id="app-view" class="hidden">
            <!-- Tabs -->
            <div class="flex flex-wrap bg-gray-200 p-2 rounded-full space-x-2 mb-8">
                <button class="tab-btn active" data-tab="obras">Obras</button>
                <button class="tab-btn" data-tab="tarefas">Tarefas</button>
                <button class="tab-btn" data-tab="cronograma">Cronograma</button>
                <button class="tab-btn" data-tab="relatorios">Relatórios</button>
            </div>

            <!-- Main Content Area -->
            <div id="content" class="card">
                <!-- Obras Section (Default View) -->
                <div id="obras-view" class="tab-content active">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold mb-2 md:mb-0">Gerenciar Obras</h2>
                        <button id="add-obra-btn" class="btn btn-primary flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            <span>Nova Obra</span>
                        </button>
                    </div>
                    <div id="obras-list" class="space-y-4">
                        <!-- Obra cards will be rendered here -->
                    </div>
                </div>

                <!-- Tarefas Section -->
                <div id="tarefas-view" class="tab-content hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold mb-2 md:mb-0">Tarefas da Obra</h2>
                        <button id="add-tarefa-btn" class="btn btn-primary flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            <span>Nova Tarefa</span>
                        </button>
                    </div>
                    <div id="tarefas-list" class="space-y-6">
                        <!-- Tarefa cards will be rendered here -->
                    </div>
                </div>

                <!-- Cronograma Section -->
                <div id="cronograma-view" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold mb-6">Cronograma da Obra</h2>
                    <div class="gantt-container">
                        <div id="gantt"></div>
                    </div>

                    <div class="flex justify-end space-x-2 mt-6">
                        <button id="export-curvaS-pdf" class="btn btn-secondary">Exportar Curva S (PDF)</button>
                        <button id="export-curvaS-excel" class="btn btn-secondary">Exportar Curva S (Excel)</button>
                        <button id="export-gantt-pdf" class="btn btn-secondary">Exportar Gantt (PDF)</button>
                        <button id="export-gantt-png" class="btn btn-secondary">Exportar Gantt (PNG)</button>
                    </div>

                    <canvas id="curvaS" class="mt-10 w-full h-64"></canvas>
                </div>

                <!-- Relatórios Section -->
                <div id="relatorios-view" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold mb-6">Relatórios</h2>
                    <div id="relatorio-content" class="space-y-6">
                        <!-- Relatórios will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-xl">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modal-title" class="text-xl font-bold">Título do Modal</h3>
            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <div id="modal-body">
            <!-- Modal form will be rendered here -->
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, getDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // Set Firebase log level for debugging
    setLogLevel('Debug');

    const firebaseConfig = {
        apiKey: "AIzaSyDrTvlOw8Ug2-GvBa2hkqDYKF7avhZ5cFA",
        authDomain: "medicoes-ppci.firebaseapp.com",
        projectId: "medicoes-ppci",
        storageBucket: "medicoes-ppci.firebasestorage.app",
        messagingSenderId: "408815173796",
        appId: "1:408815173796:web:efd25d921a7f0ee923e631",
        measurementId: "G-9YW2XQH2HH"
    };

    const API_KEY = ''; 

    // Variáveis que podem ser definidas pelo ambiente de execução (não altere)
    const __app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : firebaseConfig.appId;
    const __firebase_config = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : firebaseConfig;
    const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : undefined;

    let app;
    let auth;
    let db;
    let userId = null;
    let audioContext;

    let currentObraId = null;

    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const addObraBtn = document.getElementById('add-obra-btn');
    const addTarefaBtn = document.getElementById('add-tarefa-btn');
    const obrasList = document.getElementById('obras-list');
    const tarefasList = document.getElementById('tarefas-list');
    const relatorioContent = document.getElementById('relatorio-content');
    const userIdDisplay = document.getElementById('userIdDisplay');

    const GEMINI_API_URL_GENERATE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
    const GEMINI_API_URL_TTS = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=';

    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const logoutBtn = document.getElementById('logout-btn');
    const loginForm = document.getElementById('login-form');
    const loginBtn = document.getElementById('login-btn');
    const createAccountBtn = document.getElementById('create-account-btn');

    // Utility function to format currency
    const formatCurrency = (value) => {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    };

    // Utility function to calculate percentage
    const calculatePercentage = (numerator, denominator) => {
        if (denominator === 0) return 0;
        return (numerator / denominator) * 100;
    };

    // Modal functions
    const openModal = (title, content) => {
        modalTitle.textContent = title;
        modalBody.innerHTML = content;
        modal.classList.remove('hidden');
    };

    const closeModal = () => {
        modal.classList.add('hidden');
        modalTitle.textContent = '';
        modalBody.innerHTML = '';
    };

    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });

    // Tab switching logic
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.add('hidden'));

            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-view`).classList.remove('hidden');

            if (tab.dataset.tab === 'tarefas') {
                if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click();
                } else {
                    renderTarefas();
                }
            } else if (tab.dataset.tab === 'cronograma') {
                if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click();
                } else {
                    renderCronograma();
                }
            } else if (tab.dataset.tab === 'relatorios') {
                 if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click();
                } else {
                    renderRelatorios();
                }
            }
        });
    });

    // Firebase Initialization & Auth
    const initFirebase = async () => {
        try {
            app = initializeApp(__firebase_config);
            auth = getAuth(app);
            db = getFirestore(app);
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    listenToObras();
                } else {
                    userId = null;
                    userIdDisplay.textContent = "N/A";
                    loginView.classList.remove('hidden');
                    appView.classList.add('hidden');
                }
            });

        } catch (error) {
            console.error("Erro ao inicializar Firebase ou autenticar:", error);
        }
    };
    
    loginBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            openModal('Erro de Login', `<p class="text-center text-gray-700">Ocorreu um erro ao fazer login: ${error.message}</p>`);
        }
    });
    
    createAccountBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            openModal('Sucesso', '<p class="text-center text-green-600">Conta criada com sucesso! Você foi logado automaticamente.</p>');
        } catch (error) {
            openModal('Erro ao Criar Conta', `<p class="text-center text-gray-700">Ocorreu um erro ao criar a conta: ${error.message}</p>`);
        }
    });

    logoutBtn.addEventListener('click', async () => {
        await signOut(auth);
        currentObraId = null;
        tabs[0].click();
    });


    // Firestore CRUD Operations
    const listenToObras = () => {
        if (!db || !userId) {
            console.error("Firestore ou UserID não inicializados. Tente novamente.");
            return;
        }
        const obrasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras`);
        onSnapshot(obrasRef, (snapshot) => {
            const obras = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderObras(obras);
        });
    };

    const addOrUpdateObra = async (obra) => {
        if (!db) {
            console.error("Firestore não inicializado.");
            return;
        }

        const obrasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras`);
        if (obra.id) {
            const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, obra.id);
            await updateDoc(docRef, obra);
        } else {
            const { id, ...newObraData } = obra;
            await addDoc(obrasRef, newObraData);
        }
        closeModal();
    };

    const addOrUpdateTarefa = async (tarefa) => {
        if (!currentObraId) return;
        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        if (tarefa.id) {
            const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefa.id);
            await updateDoc(docRef, tarefa);
        } else {
            const { id, ...newTarefaData } = tarefa;
            await addDoc(tarefasRef, newTarefaData);
        }
        closeModal();
    };

    const addMedicaoToTarefa = async (tarefaId, medicao) => {
        if (!currentObraId) return;
        const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        const tarefaDoc = await getDoc(tarefaDocRef);
        const tarefa = tarefaDoc.data();
        if (!tarefa.medicoes) {
            tarefa.medicoes = [];
        }
        tarefa.medicoes.push(medicao);
        await updateDoc(tarefaDocRef, { medicoes: tarefa.medicoes });
    };

    const updateMedicaoInTarefa = async (tarefaId, medicaoIndex, updatedMedicao) => {
        if (!currentObraId) return;
        const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        const tarefaDoc = await getDoc(tarefaDocRef);
        const tarefa = tarefaDoc.data();
        if (tarefa.medicoes && tarefa.medicoes[medicaoIndex]) {
            tarefa.medicoes[medicaoIndex] = updatedMedicao;
            await updateDoc(tarefaDocRef, { medicoes: tarefa.medicoes });
        }
    }

    // Render functions
    const renderObras = (obras) => {
        obrasList.innerHTML = '';
        obras.forEach(obra => {
            const obraCard = document.createElement('div');
            obraCard.className = 'card cursor-pointer hover:bg-gray-50';
            obraCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-2m2 0a2 2 0 01-2-2v-4m2 4v2m-6 2H9m1.5-12h3M9 16h6m-5-6h4"></path>
                        </svg>
                        <div>
                            <p class="font-bold text-lg">${obra.nome}</p>
                            <p class="text-gray-500 text-sm">${obra.localizacao}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="edit-obra-btn text-gray-500 hover:text-gray-700" data-id="${obra.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5.5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293zM14.707 5.293a1 1 0 011.414 0l1.586 1.586a1 1 0 010 1.414l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5.5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293z"></path>
                            </svg>
                        </button>
                         <button class="delete-obra-btn text-gray-500 hover:text-gray-700" data-id="${obra.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-500">Valor Total: <span class="text-green-600 font-semibold">${formatCurrency(obra.valorTotal || 0)}</span></p>
                </div>
            `;
            obraCard.addEventListener('click', () => {
                currentObraId = obra.id;
                tabs[1].click();
            });
            obrasList.appendChild(obraCard);
        });
        document.querySelectorAll('.edit-obra-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const obraId = e.currentTarget.dataset.id;
                const obra = obras.find(o => o.id === obraId);
                openObraForm(obra);
            });
        });
        document.querySelectorAll('.delete-obra-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const obraId = e.currentTarget.dataset.id;
                openModal('Confirmação', `
                    <p class="text-center text-gray-700 mb-4">Tem certeza que deseja deletar esta obra?</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirmDeleteBtn" class="btn btn-primary">Sim</button>
                        <button id="cancelDeleteBtn" class="btn btn-secondary">Não</button>
                    </div>
                `);
                document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                    deleteObra(obraId);
                    closeModal();
                });
                document.getElementById('cancelDeleteBtn').addEventListener('click', closeModal);
            });
        });
    };
    
    const deleteObra = async (obraId) => {
        const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, obraId);
        await deleteDoc(docRef);
    }

    const renderTarefas = () => {
        if (!currentObraId) return;

        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        onSnapshot(tarefasRef, (snapshot) => {
            tarefasList.innerHTML = '';
            let totalMedido = 0;
            const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            tarefas.forEach(tarefa => {
                const valorMedido = (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
                const porcentagemConcluida = calculatePercentage(valorMedido, tarefa.valorTotal);
                const metragemConcluida = (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.metragem || 0), 0);
                const valorUnitario = tarefa.metragemTotal > 0 ? (tarefa.valorTotal / tarefa.metragemTotal) : 0;

                totalMedido += valorMedido;

                const tarefaCard = document.createElement('div');
                tarefaCard.className = 'card w-full';
                tarefaCard.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h3 class="text-xl font-bold mb-2 md:mb-0">${tarefa.nome}</h3>
                        <p class="text-sm text-gray-600">${porcentagemConcluida.toFixed(1)}% concluído</p>
                    </div>
                    <div class="bg-gray-200 rounded-full h-2 mb-4">
                        <div class="bg-green-500 h-2 rounded-full" style="width: ${porcentagemConcluida}%;"></div>
                    </div>
                    <div class="flex flex-wrap justify-between items-center text-sm text-gray-600 mb-4">
                        <span class="mb-2 md:mb-0">Metragem: ${metragemConcluida.toFixed(2)} / ${tarefa.metragemTotal.toFixed(2)}</span>
                        <span>Unidade: ${tarefa.unidade}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-500">Valor Unitário</p>
                            <p class="font-semibold">${formatCurrency(valorUnitario)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Valor Total</p>
                            <p class="font-semibold">${formatCurrency(tarefa.valorTotal)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Valor Medido</p>
                            <p class="font-semibold text-green-600">${formatCurrency(valorMedido)}</p>
                        </div>
                    </div>
                    <div class="flex flex-wrap justify-start space-x-2 mt-4">
                        <button class="btn btn-secondary add-medicao-btn mb-2 md:mb-0" data-id="${tarefa.id}">+ Medição</button>
                        <button class="btn btn-secondary ver-medicoes-btn mb-2 md:mb-0" data-id="${tarefa.id}">Ver Medições</button>
                        <button class="btn btn-secondary edit-tarefa-btn mb-2 md:mb-0" data-id="${tarefa.id}">Editar</button>
                        <button class="btn btn-secondary delete-tarefa-btn" data-id="${tarefa.id}">Excluir</button>
                    </div>
                `;
                tarefasList.appendChild(tarefaCard);
            });

            document.querySelectorAll('.add-medicao-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    const tarefa = tarefas.find(t => t.id === tarefaId);
                    openMedicaoForm(tarefa);
                });
            });

            document.querySelectorAll('.ver-medicoes-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    const tarefa = tarefas.find(t => t.id === tarefaId);
                    openMedicoesList(tarefa.id, tarefa.medicoes || []);
                });
            });

            document.querySelectorAll('.edit-tarefa-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    const tarefa = tarefas.find(t => t.id === tarefaId);
                    openTarefaForm(tarefa);
                });
            });

            document.querySelectorAll('.delete-tarefa-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    openModal('Confirmação', `
                        <p class="text-center text-gray-700 mb-4">Tem certeza que deseja deletar esta tarefa?</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmDeleteBtn" class="btn btn-primary">Sim</button>
                            <button id="cancelDeleteBtn" class="btn btn-secondary">Não</button>
                        </div>
                    `);
                    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                        deleteTarefa(tarefaId);
                        closeModal();
                    });
                    document.getElementById('cancelDeleteBtn').addEventListener('click', closeModal);
                });
            });

            // Update valor total da obra
            const obraRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, currentObraId);
            updateDoc(obraRef, { valorMedido: totalMedido });
        });
    };

    const deleteTarefa = async (tarefaId) => {
        const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        await deleteDoc(docRef);
    }

    // Função para renderizar Cronograma (Gantt + Curva S)
    const renderCronograma = async () => {
        if (!currentObraId) {
            openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
            tabs[0].click(); 
            return;
        }

        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        const snapshot = await getDocs(tarefasRef);
        const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Renderizar Gantt
        const ganttContainer = document.getElementById('gantt');
        ganttContainer.innerHTML = ''; // Limpar conteúdo anterior

        // Filtrar tarefas que têm datas de início e fim
        const tarefasComDatas = tarefas.filter(t => t.dataInicio && t.dataFim);
        
        if (tarefasComDatas.length === 0) {
            ganttContainer.innerHTML = '<p class="text-center text-gray-700">Nenhuma tarefa com datas definidas para exibir no cronograma.</p>';
            return;
        }

        // Converter para formato que o Frappe Gantt entende
        const tasks = tarefasComDatas.map(tarefa => ({
            id: tarefa.id,
            name: tarefa.nome,
            start: tarefa.dataInicio,
            end: tarefa.dataFim,
            progress: calculatePercentage(
                (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.valor || 0), 0),
                tarefa.valorTotal
            ),
            dependencies: tarefa.dependencias || ''
        }));

        // Inicializar gráfico Gantt
        const gantt = new Gantt(ganttContainer, tasks, {
            on_click: function (task) {
                console.log("Tarefa clicada:", task);
            },
            on_date_change: function (task, start, end) {
                console.log("Data alterada:", task, start, end);
                // Atualizar data no Firebase
                updateTarefaDate(task.id, start, end);
            },
            on_progress_change: function (task, progress) {
                console.log("Progresso alterado:", task, progress);
            },
            view_mode: 'Month',
            language: 'pt'
        });

        // Renderizar Curva S
        renderCurvaS(tarefas);
    };

    // Função para atualizar datas da tarefa no Firebase
    const updateTarefaDate = async (tarefaId, start, end) => {
        const tarefaRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        await updateDoc(tarefaRef, {
            dataInicio: start.toISOString().split('T')[0],
            dataFim: end.toISOString().split('T')[0]
        });
    };

    // Função para renderizar Curva S
    const renderCurvaS = (tarefas) => {
        const canvas = document.getElementById('curvaS');
        if (!canvas) return;
        
        // Limpar canvas anterior
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Calcular dados para a Curva S
        const datas = [];
        const valoresPlanejados = [];
        const valoresReais = [];
        
        // Ordenar tarefas por data
        const tarefasOrdenadas = tarefas
            .filter(t => t.dataInicio && t.dataFim)
            .sort((a, b) => new Date(a.dataInicio) - new Date(b.dataInicio));
        
        if (tarefasOrdenadas.length === 0) return;
        
        // Calcular datas do projeto
        const primeiraData = new Date(tarefasOrdenadas[0].dataInicio);
        const ultimaData = new Date(tarefasOrdenadas.reduce((latest, tarefa) => {
            const dataFim = new Date(tarefa.dataFim);
            return dataFim > latest ? dataFim : latest;
        }, new Date(tarefasOrdenadas[0].dataFim)));
        
        // Gerar array de datas (mensal)
        let dataAtual = new Date(primeiraData);
        while (dataAtual <= ultimaData) {
            datas.push(new Date(dataAtual));
            dataAtual.setMonth(dataAtual.getMonth() + 1);
        }
        
        // Calcular valores planejados (acumulado)
        let acumuladoPlanejado = 0;
        for (const data of datas) {
            // Soma o valor das tarefas que deveriam estar concluídas até esta data
            const valorMes = tarefasOrdenadas.reduce((sum, tarefa) => {
                const dataInicioTarefa = new Date(tarefa.dataInicio);
                const dataFimTarefa = new Date(tarefa.dataFim);
                
                if (dataFimTarefa <= data) {
                    // Tarefa totalmente concluída até esta data
                    return sum + (tarefa.valorTotal || 0);
                } else if (dataInicioTarefa <= data) {
                    // Tarefa parcialmente concluída (progresso linear)
                    const diasTotais = (dataFimTarefa - dataInicioTarefa) / (1000 * 60 * 60 * 24);
                    const diasAteData = (data - dataInicioTarefa) / (1000 * 60 * 60 * 24);
                    const percentual = Math.min(diasAteData / diasTotais, 1);
                    return sum + (tarefa.valorTotal || 0) * percentual;
                }
                return sum;
            }, 0);
            
            acumuladoPlanejado = valorMes;
            valoresPlanejados.push(acumuladoPlanejado);
        }
        
        // Calcular valores reais (baseado nas medições)
        let acumuladoReal = 0;
        for (const data of datas) {
            // Soma o valor das medições feitas até esta data
            const valorMes = tarefasOrdenadas.reduce((sum, tarefa) => {
                if (!tarefa.medicoes) return sum;
                
                const medicoesAteData = tarefa.medicoes.filter(medicao => {
                    const dataMedicao = new Date(medicao.data);
                    return dataMedicao <= data;
                });
                
                const valorMedido = medicoesAteData.reduce((medSum, medicao) => medSum + (medicao.valor || 0), 0);
                return sum + Math.min(valorMedido, tarefa.valorTotal || 0);
            }, 0);
            
            acumuladoReal = valorMes;
            valoresReais.push(acumuladoReal);
        }
        
        // Criar gráfico da Curva S
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: datas.map(d => d.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })),
                datasets: [
                    {
                        label: 'Planejado',
                        data: valoresPlanejados,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Realizado',
                        data: valoresReais,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Curva S - Evolução do Projeto'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Valor (R$)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Tempo'
                        }
                    }
                }
            }
        });
    };

    const renderRelatorios = async () => {
        if (!currentObraId) return;
        
        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        const snapshot = await getDocs(tarefasRef);
        const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const obraDoc = await getDoc(doc(db, `artifacts/${__app_id}/users/${userId}/obras`, currentObraId));
        const obra = obraDoc.data();
        
        let totalPlanejado = 0;
        let totalMedido = 0;
        
        tarefas.forEach(tarefa => {
            totalPlanejado += tarefa.valorTotal || 0;
            totalMedido += (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
        });
        
        const percentualConcluido = calculatePercentage(totalMedido, totalPlanejado);
        
        relatorioContent.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Valor Total Planejado</h3>
                    <p class="text-2xl font-bold text-blue-600">${formatCurrency(totalPlanejado)}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Valor Total Medido</h3>
                    <p class="text-2xl font-bold text-green-600">${formatCurrency(totalMedido)}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Percentual Concluído</h3>
                    <p class="text-2xl font-bold text-purple-600">${percentualConcluido.toFixed(1)}%</p>
                </div>
            </div>
            
            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4">Detalhamento por Tarefa</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 border-b">Tarefa</th>
                                <th class="py-2 px-4 border-b">Valor Planejado</th>
                                <th class="py-2 px-4 border-b">Valor Medido</th>
                                <th class="py-2 px-4 border-b">% Concluído</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tarefas.map(tarefa => {
                                const valorMedido = (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
                                const percentual = calculatePercentage(valorMedido, tarefa.valorTotal);
                                return `
                                    <tr>
                                        <td class="py-2 px-4 border-b">${tarefa.nome}</td>
                                        <td class="py-2 px-4 border-b">${formatCurrency(tarefa.valorTotal)}</td>
                                        <td class="py-2 px-4 border-b">${formatCurrency(valorMedido)}</td>
                                        <td class="py-2 px-4 border-b">${percentual.toFixed(1)}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="mt-8 flex justify-center space-x-4">
                <button id="export-relatorio-pdf" class="btn btn-primary">Exportar PDF</button>
                <button id="export-relatorio-excel" class="btn btn-primary">Exportar Excel</button>
            </div>
        `;
        
        document.getElementById('export-relatorio-pdf').addEventListener('click', () => exportRelatorioPDF(obra, tarefas));
        document.getElementById('export-relatorio-excel').addEventListener('click', () => exportRelatorioExcel(obra, tarefas));
    };

    // Form functions
    const openObraForm = (obra = null) => {
        const isEdit = !!obra;
        const title = isEdit ? 'Editar Obra' : 'Nova Obra';
        const content = `
            <form id="obra-form" class="space-y-4">
                <input type="hidden" id="obra-id" value="${obra?.id || ''}">
                <div>
                    <label for="obra-nome" class="block text-sm font-medium text-gray-700">Nome da Obra</label>
                    <input type="text" id="obra-nome" value="${obra?.nome || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="obra-localizacao" class="block text-sm font-medium text-gray-700">Localização</label>
                    <input type="text" id="obra-localizacao" value="${obra?.localizacao || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="obra-valorTotal" class="block text-sm font-medium text-gray-700">Valor Total (R$)</label>
                    <input type="number" id="obra-valorTotal" value="${obra?.valorTotal || ''}" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="obra-descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="obra-descricao" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${obra?.descricao || ''}</textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">${isEdit ? 'Atualizar' : 'Criar'} Obra</button>
            </form>
        `;
        openModal(title, content);
        
        document.getElementById('obra-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const obraData = {
                id: document.getElementById('obra-id').value || null,
                nome: document.getElementById('obra-nome').value,
                localizacao: document.getElementById('obra-localizacao').value,
                valorTotal: parseFloat(document.getElementById('obra-valorTotal').value),
                descricao: document.getElementById('obra-descricao').value
            };
            addOrUpdateObra(obraData);
        });
    };

    const openTarefaForm = (tarefa = null) => {
        const isEdit = !!tarefa;
        const title = isEdit ? 'Editar Tarefa' : 'Nova Tarefa';
        const content = `
            <form id="tarefa-form" class="space-y-4">
                <input type="hidden" id="tarefa-id" value="${tarefa?.id || ''}">
                <div>
                    <label for="tarefa-nome" class="block text-sm font-medium text-gray-700">Nome da Tarefa</label>
                    <input type="text" id="tarefa-nome" value="${tarefa?.nome || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="tarefa-descricao" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${tarefa?.descricao || ''}</textarea>
                </div>
                <div>
                    <label for="tarefa-unidade" class="block text-sm font-medium text-gray-700">Unidade de Medida</label>
                    <input type="text" id="tarefa-unidade" value="${tarefa?.unidade || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-metragemTotal" class="block text-sm font-medium text-gray-700">Metragem Total</label>
                    <input type="number" id="tarefa-metragemTotal" value="${tarefa?.metragemTotal || ''}" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-valorTotal" class="block text-sm font-medium text-gray-700">Valor Total (R$)</label>
                    <input type="number" id="tarefa-valorTotal" value="${tarefa?.valorTotal || ''}" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="tarefa-dataInicio" class="block text-sm font-medium text-gray-700">Data de Início</label>
                        <input type="date" id="tarefa-dataInicio" value="${tarefa?.dataInicio || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="tarefa-dataFim" class="block text-sm font-medium text-gray-700">Data de Fim</label>
                        <input type="date" id="tarefa-dataFim" value="${tarefa?.dataFim || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-full">${isEdit ? 'Atualizar' : 'Criar'} Tarefa</button>
            </form>
        `;
        openModal(title, content);
        
        document.getElementById('tarefa-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const tarefaData = {
                id: document.getElementById('tarefa-id').value || null,
                nome: document.getElementById('tarefa-nome').value,
                descricao: document.getElementById('tarefa-descricao').value,
                unidade: document.getElementById('tarefa-unidade').value,
                metragemTotal: parseFloat(document.getElementById('tarefa-metragemTotal').value),
                valorTotal: parseFloat(document.getElementById('tarefa-valorTotal').value),
                dataInicio: document.getElementById('tarefa-dataInicio').value,
                dataFim: document.getElementById('tarefa-dataFim').value
            };
            addOrUpdateTarefa(tarefaData);
        });
    };

    const openMedicaoForm = (tarefa) => {
        const content = `
            <form id="medicao-form" class="space-y-4">
                <input type="hidden" id="tarefa-id" value="${tarefa.id}">
                <div>
                    <label for="medicao-data" class="block text-sm font-medium text-gray-700">Data da Medição</label>
                    <input type="date" id="medicao-data" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="medicao-metragem" class="block text-sm font-medium text-gray-700">Metragem</label>
                    <input type="number" id="medicao-metragem" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="medicao-descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="medicao-descricao" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">Adicionar Medição</button>
            </form>
        `;
        openModal('Nova Medição', content);
        
        document.getElementById('medicao-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const valorUnitario = tarefa.valorTotal / tarefa.metragemTotal;
            const medicaoData = {
                data: document.getElementById('medicao-data').value,
                metragem: parseFloat(document.getElementById('medicao-metragem').value),
                valor: parseFloat(document.getElementById('medicao-metragem').value) * valorUnitario,
                descricao: document.getElementById('medicao-descricao').value
            };
            addMedicaoToTarefa(tarefa.id, medicaoData);
        });
    };

    const openMedicoesList = (tarefaId, medicoes) => {
        const content = `
            <div class="max-h-96 overflow-y-auto">
                <h4 class="font-semibold mb-4">Medições da Tarefa</h4>
                ${medicoes.length === 0 ? 
                    '<p class="text-center text-gray-500">Nenhuma medição registrada.</p>' : 
                    `<table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-2 px-4 border-b">Data</th>
                                <th class="text-left py-2 px-4 border-b">Metragem</th>
                                <th class="text-left py-2 px-4 border-b">Valor</th>
                                <th class="text-left py-2 px-4 border-b">Descrição</th>
                                <th class="text-left py-2 px-4 border-b">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${medicoes.map((medicao, index) => `
                                <tr>
                                    <td class="py-2 px-4 border-b">${new Date(medicao.data).toLocaleDateString('pt-BR')}</td>
                                    <td class="py-2 px-4 border-b">${medicao.metragem}</td>
                                    <td class="py-2 px-4 border-b">${formatCurrency(medicao.valor)}</td>
                                    <td class="py-2 px-4 border-b">${medicao.descricao || '-'}</td>
                                    <td class="py-2 px-4 border-b">
                                        <button class="text-blue-500 hover:text-blue-700 edit-medicao-btn" data-index="${index}">Editar</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`
                }
            </div>
        `;
        openModal('Medições da Tarefa', content);
        
        document.querySelectorAll('.edit-medicao-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                openEditMedicaoForm(tarefaId, medicoes[index], index);
            });
        });
    };

    const openEditMedicaoForm = (tarefaId, medicao, index) => {
        const content = `
            <form id="edit-medicao-form" class="space-y-4">
                <input type="hidden" id="medicao-index" value="${index}">
                <div>
                    <label for="edit-medicao-data" class="block text-sm font-medium text-gray-700">Data da Medição</label>
                    <input type="date" id="edit-medicao-data" value="${medicao.data}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="edit-medicao-metragem" class="block text-sm font-medium text-gray-700">Metragem</label>
                    <input type="number" id="edit-medicao-metragem" value="${medicao.metragem}" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="edit-medicao-descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="edit-medicao-descricao" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${medicao.descricao || ''}</textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">Atualizar Medição</button>
            </form>
        `;
        openModal('Editar Medição', content);
        
        document.getElementById('edit-medicao-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
            getDoc(tarefaDocRef).then((doc) => {
                if (doc.exists()) {
                    const tarefa = doc.data();
                    const updatedMedicao = {
                        data: document.getElementById('edit-medicao-data').value,
                        metragem: parseFloat(document.getElementById('edit-medicao-metragem').value),
                        descricao: document.getElementById('edit-medicao-descricao').value
                    };
                    // Recalcular o valor baseado na metragem
                    const valorUnitario = tarefa.valorTotal / tarefa.metragemTotal;
                    updatedMedicao.valor = updatedMedicao.metragem * valorUnitario;
                    
                    tarefa.medicoes[index] = updatedMedicao;
                    updateDoc(tarefaDocRef, { medicoes: tarefa.medicoes }).then(() => {
                        closeModal();
                        openMedicoesList(tarefaId, tarefa.medicoes);
                    });
                }
            });
        });
    };

    // Export functions
    const exportRelatorioPDF = (obra, tarefas) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.text(`Relatório da Obra: ${obra.nome}`, 105, 15, { align: 'center' });
        doc.setFontSize(12);
        doc.text(`Localização: ${obra.localizacao}`, 20, 25);
        doc.text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`, 20, 32);
        
        let totalPlanejado = 0;
        let totalMedido = 0;
        
        tarefas.forEach(tarefa => {
            totalPlanejado += tarefa.valorTotal || 0;
            totalMedido += (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
        });
        
        const percentualConcluido = calculatePercentage(totalMedido, totalPlanejado);
        
        doc.setFontSize(14);
        doc.text('Resumo Geral', 20, 45);
        doc.setFontSize(12);
        doc.text(`Valor Total Planejado: ${formatCurrency(totalPlanejado)}`, 20, 55);
        doc.text(`Valor Total Medido: ${formatCurrency(totalMedido)}`, 20, 62);
        doc.text(`Percentual Concluído: ${percentualConcluido.toFixed(1)}%`, 20, 69);
        
        // Tabela de tarefas
        let y = 85;
        doc.setFontSize(14);
        doc.text('Detalhamento por Tarefa', 20, y);
        y += 10;
        
        doc.setFontSize(10);
        doc.text('Tarefa', 20, y);
        doc.text('Valor Planejado', 80, y);
        doc.text('Valor Medido', 120, y);
        doc.text('% Concluído', 160, y);
        y += 7;
        
        doc.line(20, y, 190, y);
        y += 5;
        
        tarefas.forEach(tarefa => {
            const valorMedido = (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
            const percentual = calculatePercentage(valorMedido, tarefa.valorTotal);
            
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
            
            doc.text(tarefa.nome.substring(0, 30), 20, y);
            doc.text(formatCurrency(tarefa.valorTotal), 80, y);
            doc.text(formatCurrency(valorMedido), 120, y);
            doc.text(`${percentual.toFixed(1)}%`, 160, y);
            y += 7;
        });
        
        doc.save(`relatorio-${obra.nome}.pdf`);
    };

    const exportRelatorioExcel = (obra, tarefas) => {
        const data = [
            ['Tarefa', 'Valor Planejado', 'Valor Medido', '% Concluído']
        ];
        
        tarefas.forEach(tarefa => {
            const valorMedido = (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
            const percentual = calculatePercentage(valorMedido, tarefa.valorTotal);
            data.push([
                tarefa.nome,
                tarefa.valorTotal,
                valorMedido,
                percentual
            ]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Relatório');
        XLSX.writeFile(wb, `relatorio-${obra.nome}.xlsx`);
    };

    // Event Listeners
    addObraBtn.addEventListener('click', () => openObraForm());
    addTarefaBtn.addEventListener('click', () => openTarefaForm());

    // Initialize Firebase
    initFirebase();

    // Adicionar event listeners para os botões de exportação do cronograma
    document.getElementById('export-gantt-pdf')?.addEventListener('click', exportGanttPDF);
    document.getElementById('export-gantt-png')?.addEventListener('click', exportGanttPNG);
    document.getElementById('export-curvaS-pdf')?.addEventListener('click', exportCurvaSPDF);
    document.getElementById('export-curvaS-excel')?.addEventListener('click', exportCurvaSExcel);

    // Funções de exportação do cronograma
    function exportGanttPDF() {
        openModal('Exportar Gantt', '<p class="text-center text-gray-700">Funcionalidade de exportação PDF do Gantt será implementada em breve.</p>');
    }

    function exportGanttPNG() {
        openModal('Exportar Gantt', '<p class="text-center text-gray-700">Funcionalidade de exportação PNG do Gantt será implementada em breve.</p>');
    }

    function exportCurvaSPDF() {
        openModal('Exportar Curva S', '<p class="text-center text-gray-700">Funcionalidade de exportação PDF da Curva S será implementada em breve.</p>');
    }

    function exportCurvaSExcel() {
        openModal('Exportar Curva S', '<p class="text-center text-gray-700">Funcionalidade de exportação Excel da Curva S será implementada em breve.</p>');
    }
</script>
</body>
</html>
