<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medições PPCI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: url('https://placehold.co/1920x1080/494C4F/494C4F?text=') no-repeat center center fixed; /* Fundo escuro */
            background-size: cover;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
            color: #000;
        }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #E21B2F; /* Vermelho do logo */
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #c7172a; /* Tom mais escuro */
        }
        .btn-secondary {
            background-color: #e9ecef;
            color: #495057;
        }
        .btn-secondary:hover {
            background-color: #dee2e6;
        }
        .tab-btn {
            flex-grow: 1;
            padding: 1rem;
            border-radius: 9999px;
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
        }
        .tab-btn.active {
            background-color: #494C4F; /* Cinza do logo */
            color: #fff;
        }

        /* Estilos para campos de input para garantir visibilidade */
        input[type="text"], input[type="number"], input[type="date"], textarea {
            color: #000;
        }

        .medicoes-list-item {
            color: #000;
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center space-x-4">
            <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm-1-13h2v6h-2V7zm0 8h2v2h-2v-2z"></path>
            </svg>
            <div>
                <h1 class="text-3xl font-bold text-white">Medições PPCI</h1>
                <p class="text-white">Sistema de Gestão de Obras</p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <span class="text-white">ID: <span id="userIdDisplay" class="font-mono"></span></span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex bg-gray-200 p-2 rounded-full space-x-2 mb-8">
        <button class="tab-btn active" data-tab="obras">Obras</button>
        <button class="tab-btn" data-tab="tarefas">Tarefas</button>
        <button class="tab-btn" data-tab="relatorios">Relatórios</button>
    </div>

    <!-- Main Content Area -->
    <div id="content" class="card">
        <!-- Obras Section (Default View) -->
        <div id="obras-view" class="tab-content active">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Gerenciar Obras</h2>
                <button id="add-obra-btn" class="btn btn-primary flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span>Nova Obra</span>
                </button>
            </div>
            <div id="obras-list" class="space-y-4">
                <!-- Obra cards will be rendered here -->
            </div>
        </div>

        <!-- Tarefas Section -->
        <div id="tarefas-view" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Tarefas da Obra</h2>
                <button id="add-tarefa-btn" class="btn btn-primary flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span>Nova Tarefa</span>
                </button>
            </div>
            <div id="tarefas-list" class="space-y-6">
                <!-- Tarefa cards will be rendered here -->
            </div>
        </div>

        <!-- Relatórios Section -->
        <div id="relatorios-view" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6">Relatórios</h2>
            <div id="relatorio-content" class="space-y-6">
                <!-- Relatórios will be rendered here -->
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-xl">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modal-title" class="text-xl font-bold">Título do Modal</h3>
            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <div id="modal-body">
            <!-- Modal form will be rendered here -->
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, getDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firebase log level for debugging
    setLogLevel('Debug');

    const __app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
    const __firebase_config = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {};
    const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : undefined;

    let app;
    let auth;
    let db;
    let userId;
    let audioContext;

    let currentObraId = null;

    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const addObraBtn = document.getElementById('add-obra-btn');
    const addTarefaBtn = document.getElementById('add-tarefa-btn');
    const obrasList = document.getElementById('obras-list');
    const tarefasList = document.getElementById('tarefas-list');
    const relatorioContent = document.getElementById('relatorio-content');
    const userIdDisplay = document.getElementById('userIdDisplay');

    const GEMINI_API_URL_GENERATE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
    const GEMINI_API_URL_TTS = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=';
    const API_KEY = '';

    // Utility function to format currency
    const formatCurrency = (value) => {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    };

    // Utility function to calculate percentage
    const calculatePercentage = (numerator, denominator) => {
        if (denominator === 0) return 0;
        return (numerator / denominator) * 100;
    };

    // Modal functions
    const openModal = (title, content) => {
        modalTitle.textContent = title;
        modalBody.innerHTML = content;
        modal.classList.remove('hidden');
    };

    const closeModal = () => {
        modal.classList.add('hidden');
        modalTitle.textContent = '';
        modalBody.innerHTML = '';
    };

    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });

    // Tab switching logic
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.add('hidden'));

            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-view`).classList.remove('hidden');

            if (tab.dataset.tab === 'tarefas') {
                if (!currentObraId) {
                    // Crie um modal customizado no lugar do alert() para melhorar a UX
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click(); // Go back to obras tab
                } else {
                    renderTarefas();
                }
            } else if (tab.dataset.tab === 'relatorios') {
                 if (!currentObraId) {
                    // Crie um modal customizado no lugar do alert() para melhorar a UX
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click(); // Go back to obras tab
                } else {
                    renderRelatorios();
                }
            }
        });
    });

    // Firebase Initialization & Auth
    const initFirebase = async () => {
        try {
            app = initializeApp(__firebase_config);
            auth = getAuth(app);
            db = getFirestore(app);
            audioContext = new (window.AudioContext || window.webkitAudioContext)();


            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    await signInAnonymously(auth);
                }
                userIdDisplay.textContent = userId;
                listenToObras();
            });

            if (__initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Erro ao inicializar Firebase ou autenticar:", error);
        }
    };

    // Firestore CRUD Operations
    const listenToObras = () => {
        const obrasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras`);
        onSnapshot(obrasRef, (snapshot) => {
            const obras = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderObras(obras);
        });
    };

    const addOrUpdateObra = async (obra) => {
        const obrasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras`);
        if (obra.id) {
            const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, obra.id);
            await updateDoc(docRef, obra);
        } else {
            // Remove o campo 'id' para evitar o erro "Unsupported field value: undefined (found in field id)"
            const { id, ...newObraData } = obra;
            await addDoc(obrasRef, newObraData);
        }
        closeModal();
    };

    const addOrUpdateTarefa = async (tarefa) => {
        if (!currentObraId) return;
        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        if (tarefa.id) {
            const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefa.id);
            await updateDoc(docRef, tarefa);
        } else {
            const { id, ...newTarefaData } = tarefa;
            await addDoc(tarefasRef, newTarefaData);
        }
        closeModal();
    };

    const addMedicaoToTarefa = async (tarefaId, medicao) => {
        if (!currentObraId) return;
        const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        const tarefaDoc = await getDoc(tarefaDocRef);
        const tarefa = tarefaDoc.data();
        if (!tarefa.medicoes) {
            tarefa.medicoes = [];
        }
        tarefa.medicoes.push(medicao);
        await updateDoc(tarefaDocRef, { medicoes: tarefa.medicoes });
    };

    const updateMedicaoInTarefa = async (tarefaId, medicaoIndex, updatedMedicao) => {
        if (!currentObraId) return;
        const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        const tarefaDoc = await getDoc(tarefaDocRef);
        const tarefa = tarefaDoc.data();
        if (tarefa.medicoes && tarefa.medicoes[medicaoIndex]) {
            tarefa.medicoes[medicaoIndex] = updatedMedicao;
            await updateDoc(tarefaDocRef, { medicoes: tarefa.medicoes });
        }
    }


    // Render functions
    const renderObras = (obras) => {
        obrasList.innerHTML = '';
        obras.forEach(obra => {
            const obraCard = document.createElement('div');
            obraCard.className = 'card cursor-pointer hover:bg-gray-50';
            obraCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-2m2 0a2 2 0 01-2-2v-4m2 4v2m-6 2H9m1.5-12h3M9 16h6m-5-6h4"></path>
                        </svg>
                        <div>
                            <p class="font-bold text-lg">${obra.nome}</p>
                            <p class="text-gray-500 text-sm">${obra.localizacao}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="edit-obra-btn text-gray-500 hover:text-gray-700" data-id="${obra.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5.5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293zM14.707 5.293a1 1 0 011.414 0l1.586 1.586a1 1 0 010 1.414l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5.5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293z"></path>
                            </svg>
                        </button>
                         <button class="delete-obra-btn text-gray-500 hover:text-gray-700" data-id="${obra.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-500">Valor Total: <span class="text-green-600 font-semibold">${formatCurrency(obra.valorTotal || 0)}</span></p>
                </div>
            `;
            obraCard.addEventListener('click', () => {
                currentObraId = obra.id;
                tabs[1].click(); // Switch to Tarefas tab
            });
            obrasList.appendChild(obraCard);
        });
        document.querySelectorAll('.edit-obra-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const obraId = e.currentTarget.dataset.id;
                const obra = obras.find(o => o.id === obraId);
                openObraForm(obra);
            });
        });
        document.querySelectorAll('.delete-obra-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const obraId = e.currentTarget.dataset.id;
                // Crie um modal customizado no lugar do confirm()
                openModal('Confirmação', `
                    <p class="text-center text-gray-700 mb-4">Tem certeza que deseja deletar esta obra?</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirmDeleteBtn" class="btn btn-primary">Sim</button>
                        <button id="cancelDeleteBtn" class="btn btn-secondary">Não</button>
                    </div>
                `);
                document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                    deleteObra(obraId);
                    closeModal();
                });
                document.getElementById('cancelDeleteBtn').addEventListener('click', closeModal);
            });
        });
    };
    
    const deleteObra = async (obraId) => {
        const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, obraId);
        await deleteDoc(docRef);
    }

    const renderTarefas = () => {
        if (!currentObraId) return;

        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        onSnapshot(tarefasRef, (snapshot) => {
            tarefasList.innerHTML = '';
            let totalMedido = 0;
            const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            tarefas.forEach(tarefa => {
                const valorMedido = (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
                const porcentagemConcluida = calculatePercentage(valorMedido, tarefa.valorTotal);
                const metragemConcluida = (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.metragem || 0), 0);
                const valorUnitario = tarefa.metragemTotal > 0 ? (tarefa.valorTotal / tarefa.metragemTotal) : 0;

                totalMedido += valorMedido;

                const tarefaCard = document.createElement('div');
                tarefaCard.className = 'card';
                tarefaCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">${tarefa.nome}</h3>
                        <p class="text-sm text-gray-600">${porcentagemConcluida.toFixed(1)}% concluído</p>
                    </div>
                    <div class="bg-gray-200 rounded-full h-2 mb-4">
                        <div class="bg-green-500 h-2 rounded-full" style="width: ${porcentagemConcluida}%;"></div>
                    </div>
                    <div class="flex justify-between items-center text-sm text-gray-600 mb-4">
                        <span>Metragem: ${metragemConcluida.toFixed(2)} / ${tarefa.metragemTotal.toFixed(2)}</span>
                        <span>Unidade: ${tarefa.unidade}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-500">Valor Unitário</p>
                            <p class="font-semibold">${formatCurrency(valorUnitario)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Valor Total</p>
                            <p class="font-semibold">${formatCurrency(tarefa.valorTotal)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Valor Medido</p>
                            <p class="font-semibold text-green-600">${formatCurrency(valorMedido)}</p>
                        </div>
                    </div>
                    <div class="flex justify-start space-x-2 mt-4">
                        <button class="btn btn-secondary add-medicao-btn" data-id="${tarefa.id}">+ Medição</button>
                        <button class="btn btn-secondary ver-medicoes-btn" data-id="${tarefa.id}">Ver Medições</button>
                        <button class="btn btn-secondary edit-tarefa-btn" data-id="${tarefa.id}">Editar</button>
                        <button class="btn btn-secondary delete-tarefa-btn" data-id="${tarefa.id}">Excluir</button>
                    </div>
                `;
                tarefasList.appendChild(tarefaCard);
            });

            document.querySelectorAll('.add-medicao-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    const tarefa = tarefas.find(t => t.id === tarefaId);
                    openMedicaoForm(tarefa);
                });
            });

            document.querySelectorAll('.ver-medicoes-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    const tarefa = tarefas.find(t => t.id === tarefaId);
                    openMedicoesList(tarefa.id, tarefa.medicoes || []);
                });
            });

            document.querySelectorAll('.edit-tarefa-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    const tarefa = tarefas.find(t => t.id === tarefaId);
                    openTarefaForm(tarefa);
                });
            });

            document.querySelectorAll('.delete-tarefa-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tarefaId = e.currentTarget.dataset.id;
                    // Crie um modal customizado no lugar do confirm()
                    openModal('Confirmação', `
                        <p class="text-center text-gray-700 mb-4">Tem certeza que deseja deletar esta tarefa?</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmDeleteBtn" class="btn btn-primary">Sim</button>
                            <button id="cancelDeleteBtn" class="btn btn-secondary">Não</button>
                        </div>
                    `);
                    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                        deleteTarefa(tarefaId);
                        closeModal();
                    });
                    document.getElementById('cancelDeleteBtn').addEventListener('click', closeModal);
                });
            });

            // Update valor total da obra
            const obraRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, currentObraId);
            updateDoc(obraRef, { valorMedido: totalMedido });
        });
    };

    const deleteTarefa = async (tarefaId) => {
        const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
        await deleteDoc(docRef);
    }

    const renderRelatorios = async () => {
        if (!currentObraId) {
            relatorioContent.innerHTML = '<p class="text-center text-gray-600">Selecione uma obra na aba "Obras" para visualizar os relatórios.</p>';
            return;
        }

        const obraDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, currentObraId);
        const obraDoc = await getDoc(obraDocRef);
        const obra = obraDoc.data();

        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        const snapshot = await getDocs(tarefasRef);
        const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        let totalTarefas = tarefas.length;
        let totalConcluidas = tarefas.filter(t => (t.medicoes || []).reduce((sum, m) => sum + (m.valor || 0), 0) >= t.valorTotal).length;
        let valorMedidoTotal = tarefas.reduce((sum, t) => sum + (t.medicoes || []).reduce((sum, m) => sum + (m.valor || 0), 0), 0);
        let progressoGeral = calculatePercentage(valorMedidoTotal, obra.valorTotal);

        relatorioContent.innerHTML = `
            <h3 class="text-xl font-semibold mb-4">Relatório Geral da Obra</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="p-6 bg-gray-100 rounded-lg">
                    <p class="text-gray-500">Total de Tarefas</p>
                    <p class="text-3xl font-bold">${totalTarefas}</p>
                    <p class="text-sm text-gray-500">${totalConcluidas} concluídas</p>
                </div>
                <div class="p-6 bg-gray-100 rounded-lg">
                    <p class="text-gray-500">Valor Total Medido</p>
                    <p class="text-3xl font-bold text-green-600">${formatCurrency(valorMedidoTotal)}</p>
                    <p class="text-sm text-gray-500">de ${formatCurrency(obra.valorTotal)} total</p>
                </div>
                <div class="p-6 bg-gray-100 rounded-lg">
                    <p class="text-gray-500">Progresso Geral</p>
                    <p class="text-3xl font-bold">${progressoGeral.toFixed(1)}%</p>
                    <p class="text-sm text-gray-500">média das tarefas</p>
                </div>
            </div>

            <hr class="my-8">

            <h3 class="text-xl font-semibold mb-4 flex items-center justify-between">
                Relatório por Período
                <button id="read-summary-btn" class="btn btn-primary ml-4">Ouvir Resumo ✨</button>
            </h3>
            <div class="space-y-4">
                <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-4 md:space-y-0">
                    <div class="flex-1">
                        <label for="start-date" class="block text-sm font-medium text-gray-700">Data de Início</label>
                        <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div class="flex-1">
                        <label for="end-date" class="block text-sm font-medium text-gray-700">Data de Fim</label>
                        <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <button id="generate-period-report-btn" class="btn btn-primary">Gerar Relatório</button>
                </div>
                <div id="period-report-result" class="mt-6">
                    <!-- O resultado do relatório por período será renderizado aqui -->
                </div>
            </div>
        `;
        
        const generateBtn = document.getElementById('generate-period-report-btn');
        generateBtn.addEventListener('click', () => {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            renderRelatorioPorPeriodo(startDate, endDate, tarefas, obra.nome);
        });

        document.getElementById('read-summary-btn').addEventListener('click', async () => {
            const summaryText = `Resumo da obra ${obra.nome}. Total de tarefas: ${totalTarefas}. ${totalConcluidas} concluídas. Valor total medido: ${formatCurrency(valorMedidoTotal)}. Progresso geral: ${progressoGeral.toFixed(1)}%`;
            await speakText(summaryText);
        });

    };

    // Função para converter ArrayBuffer para Blob
    const pcmToWav = (pcm16, sampleRate) => {
        const pcmData = pcm16.buffer;
        const numChannels = 1;
        const bitsPerSample = 16;
        const byteRate = sampleRate * numChannels * bitsPerSample / 8;
        const blockAlign = numChannels * bitsPerSample / 8;
        const wavDataSize = pcmData.byteLength;
        const fileSize = wavDataSize + 44;

        const buffer = new ArrayBuffer(fileSize);
        const view = new DataView(buffer);

        // RIFF chunk
        writeString(view, 0, 'RIFF');
        view.setUint32(4, fileSize - 8, true);
        writeString(view, 8, 'WAVE');

        // fmt chunk
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitsPerSample, true);

        // data chunk
        writeString(view, 36, 'data');
        view.setUint32(40, wavDataSize, true);

        // PCM data
        const pcmView = new Int16Array(pcmData);
        for (let i = 0; i < pcmView.length; i++) {
            view.setInt16(44 + i * 2, pcmView[i], true);
        }

        return new Blob([view], { type: 'audio/wav' });
    };

    const writeString = (view, offset, string) => {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    };

    // Function to convert Base64 to ArrayBuffer
    const base64ToArrayBuffer = (base64) => {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    };

    // Speak text with TTS API
    const speakText = async (text) => {
        const payload = {
            contents: [{ parts: [{ text: text }] }],
            generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: {
                    voiceConfig: {
                        prebuiltVoiceConfig: { voiceName: "Iapetus" }
                    }
                }
            }
        };

        try {
            const response = await fetch(`${GEMINI_API_URL_TTS}${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                console.error('API call failed:', response.status, response.statusText);
                return;
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                
                const audio = new Audio(audioUrl);
                audio.play();

            } else {
                console.error('Invalid audio data received');
            }
        } catch (error) {
            console.error('Error in TTS API call:', error);
        }
    };


    const renderRelatorioPorPeriodo = (startDate, endDate, tarefas, nomeObra) => {
        const reportResultDiv = document.getElementById('period-report-result');
        reportResultDiv.innerHTML = '';

        if (!startDate || !endDate) {
            reportResultDiv.innerHTML = '<p class="text-red-500">Por favor, selecione as duas datas para gerar o relatório.</p>';
            return;
        }

        const start = new Date(startDate);
        const end = new Date(endDate);
        end.setDate(end.getDate() + 1); // Garante que o dia final seja incluído

        let totalPeriodo = 0;
        let relatorioHtml = '';
        let hasData = false;

        const reportData = [];
        const taskTotals = {};

        tarefas.forEach(tarefa => {
            const medicoesPeriodo = (tarefa.medicoes || []).filter(medicao => {
                const medicaoDate = new Date(medicao.data);
                return medicaoDate >= start && medicaoDate < end;
            });

            if (medicoesPeriodo.length > 0) {
                hasData = true;
                const valorPeriodoTarefa = medicoesPeriodo.reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
                totalPeriodo += valorPeriodoTarefa;
                
                if (!taskTotals[tarefa.nome]) {
                    taskTotals[tarefa.nome] = 0;
                }
                taskTotals[tarefa.nome] += valorPeriodoTarefa;


                relatorioHtml += `
                    <div class="card p-4 mb-4">
                        <p class="font-semibold text-lg">${tarefa.nome}</p>
                        <p class="text-sm text-gray-500 mb-2">Medições realizadas no período:</p>
                        <ul class="list-disc list-inside space-y-1">
                            ${medicoesPeriodo.map(m => {
                                const medicaoInfo = `Metragem: ${m.metragem.toFixed(2)} ${tarefa.unidade} - ${formatCurrency(m.valor)} em ${new Date(m.data).toLocaleDateString()}`;
                                reportData.push({
                                    'Tarefa': tarefa.nome,
                                    'Metragem': m.metragem,
                                    'Unidade': tarefa.unidade,
                                    'Valor': m.valor,
                                    'Data': new Date(m.data).toLocaleDateString(),
                                    'Observacoes': m.observacoes || ''
                                });
                                return `<li>${medicaoInfo}</li>`;
                            }).join('')}
                        </ul>
                        <div class="mt-2 text-sm">
                            <p class="font-bold">Total Medido nesta tarefa: <span class="text-green-600">${formatCurrency(valorPeriodoTarefa)}</span></p>
                        </div>
                    </div>
                `;
            }
        });

        if (!hasData) {
            reportResultDiv.innerHTML = '<p class="text-center text-gray-600">Nenhuma medição encontrada no período selecionado.</p>';
        } else {
            reportResultDiv.innerHTML = `
                <div class="p-6 bg-gray-200 rounded-lg mb-6 flex flex-col md:flex-row justify-between items-center">
                    <div>
                        <p class="text-gray-600 font-bold text-xl">Total a Receber no Período:</p>
                        <p class="text-4xl font-extrabold text-green-700 mt-2">${formatCurrency(totalPeriodo)}</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex space-x-2">
                        <button id="export-pdf-btn" class="btn btn-secondary">Exportar PDF</button>
                        <button id="export-excel-btn" class="btn btn-secondary">Exportar Excel</button>
                    </div>
                </div>
                ${relatorioHtml}
            `;

            document.getElementById('export-pdf-btn').addEventListener('click', () => {
                exportPDF(reportData, taskTotals, nomeObra, startDate, endDate, totalPeriodo);
            });
            document.getElementById('export-excel-btn').addEventListener('click', () => {
                exportExcel(reportData, taskTotals, nomeObra, startDate, endDate, totalPeriodo);
            });
        }
    };

    const exportPDF = (data, taskTotals, nomeObra, startDate, endDate, total) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text(`Relatório de Medições - ${nomeObra}`, 14, 22);

        doc.setFontSize(12);
        doc.text(`Período: ${new Date(startDate).toLocaleDateString()} a ${new Date(endDate).toLocaleDateString()}`, 14, 30);
        doc.text(`Total a Receber: ${formatCurrency(total)}`, 14, 38);

        // First table: detailed report
        const columns = ["Tarefa", "Metragem", "Unidade", "Valor (R$)", "Data", "Observações"];
        const rows = data.map(item => [
            item.Tarefa,
            item.Metragem.toFixed(2),
            item.Unidade,
            item.Valor.toFixed(2),
            item.Data,
            item.Observacoes
        ]);
        doc.autoTable({
            head: [columns],
            body: rows,
            startY: 45
        });

        // Second table: task totals
        const taskTotalColumns = ["Tarefa", "Total a Receber"];
        const taskTotalRows = Object.keys(taskTotals).map(taskName => [
            taskName,
            formatCurrency(taskTotals[taskName])
        ]);
        doc.autoTable({
            head: [taskTotalColumns],
            body: taskTotalRows,
            startY: doc.autoTable.previous.finalY + 10,
            theme: 'striped',
            headStyles: { fillColor: [52, 58, 64] },
            bodyStyles: { textColor: [33, 37, 41] },
        });

        doc.save(`relatorio_${nomeObra}_${startDate}_${endDate}.pdf`);
    };

    const exportExcel = (data, taskTotals, nomeObra, startDate, endDate, total) => {
        // Prepare detailed data
        const detailedData = [
            ["Relatório de Medições"],
            [`Obra: ${nomeObra}`],
            [`Período: ${new Date(startDate).toLocaleDateString()} a ${new Date(endDate).toLocaleDateString()}`],
            [`Total a Receber: ${formatCurrency(total)}`],
            [],
            ["Relatório Detalhado"],
            ["Tarefa", "Metragem", "Unidade", "Valor (R$)", "Data", "Observações"]
        ].concat(data.map(item => [
            item.Tarefa,
            item.Metragem,
            item.Unidade,
            item.Valor,
            item.Data,
            item.Observacoes
        ]));

        // Prepare task totals data
        const taskTotalData = [
            [],
            [],
            ["Totais por Tarefa"],
            ["Tarefa", "Total a Receber"]
        ].concat(Object.keys(taskTotals).map(taskName => [
            taskName,
            taskTotals[taskName]
        ]));

        const worksheet = XLSX.utils.aoa_to_sheet(detailedData.concat(taskTotalData));
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Relatorio");
        XLSX.writeFile(workbook, `relatorio_${nomeObra}_${startDate}_${endDate}.xlsx`);
    };

    // Forms
    const openObraForm = (obra = {}) => {
        const formHtml = `
            <form id="obra-form" class="space-y-4">
                <div>
                    <label for="obra-nome" class="block text-sm font-medium text-gray-700">Nome da Obra</label>
                    <input type="text" id="obra-nome" name="nome" value="${obra.nome || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                </div>
                <div>
                    <label for="obra-localizacao" class="block text-sm font-medium text-gray-700">Localização</label>
                    <input type="text" id="obra-localizacao" name="localizacao" value="${obra.localizacao || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                </div>
                <div>
                    <label for="obra-valor" class="block text-sm font-medium text-gray-700">Valor Total (R$)</label>
                    <input type="number" id="obra-valor" name="valorTotal" value="${obra.valorTotal || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">${obra.id ? 'Atualizar' : 'Salvar'}</button>
            </form>
        `;
        openModal(obra.id ? 'Editar Obra' : 'Nova Obra', formHtml);
        document.getElementById('obra-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newObra = {
                nome: formData.get('nome'),
                localizacao: formData.get('localizacao'),
                valorTotal: parseFloat(formData.get('valorTotal')),
                valorMedido: obra.valorMedido || 0
            };
            addOrUpdateObra({ ...newObra, id: obra.id });
        });
    };
    
    const openTarefaForm = (tarefa = {}) => {
        const formHtml = `
            <form id="tarefa-form" class="space-y-4">
                <div>
                    <label for="tarefa-nome" class="block text-sm font-medium text-gray-700">Nome da Tarefa</label>
                    <input type="text" id="tarefa-nome" name="nome" value="${tarefa.nome || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-metragem-total" class="block text-sm font-medium text-gray-700">Metragem Total</label>
                    <input type="number" step="0.01" id="tarefa-metragem-total" name="metragemTotal" value="${tarefa.metragemTotal || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-unidade" class="block text-sm font-medium text-gray-700">Unidade (m, un, etc.)</label>
                    <input type="text" id="tarefa-unidade" name="unidade" value="${tarefa.unidade || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-valor-total" class="block text-sm font-medium text-gray-700">Valor Total</label>
                    <input type="number" step="0.01" id="tarefa-valor-total" name="valorTotal" value="${tarefa.valorTotal || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="tarefa-descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="tarefa-descricao" name="descricao" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${tarefa.descricao || ''}</textarea>
                    <button type="button" id="gerar-descricao-btn" class="btn btn-secondary mt-2">Gerar Descrição ✨</button>
                </div>
                <button type="submit" class="btn btn-primary w-full">${tarefa.id ? 'Atualizar' : 'Salvar'}</button>
            </form>
        `;
        openModal(tarefa.id ? 'Editar Tarefa' : 'Nova Tarefa', formHtml);
        document.getElementById('tarefa-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const metragemTotal = parseFloat(formData.get('metragemTotal'));
            const valorTotal = parseFloat(formData.get('valorTotal'));
            const valorUnitario = metragemTotal > 0 ? (valorTotal / metragemTotal) : 0;
            const newTarefa = {
                nome: formData.get('nome'),
                metragemTotal: metragemTotal,
                unidade: formData.get('unidade'),
                valorUnitario: valorUnitario,
                valorTotal: valorTotal,
                descricao: formData.get('descricao'),
                medicoes: tarefa.medicoes || []
            };
            addOrUpdateTarefa({ ...newTarefa, id: tarefa.id });
        });

        document.getElementById('gerar-descricao-btn').addEventListener('click', () => {
            const nome = document.getElementById('tarefa-nome').value;
            const unidade = document.getElementById('tarefa-unidade').value;
            if (nome && unidade) {
                generateTaskDescription(nome, unidade);
            } else {
                openModal('Atenção', 'Por favor, preencha o nome da tarefa e a unidade primeiro.');
            }
        });
    };

    // LLM - Gerador de Descrição de Tarefa
    const generateTaskDescription = async (nome, unidade) => {
        const descricaoTextarea = document.getElementById('tarefa-descricao');
        const generateBtn = document.getElementById('gerar-descricao-btn');
        const originalBtnText = generateBtn.textContent;
        generateBtn.disabled = true;
        generateBtn.textContent = 'Gerando...';
        
        const prompt = `Gere uma descrição concisa e profissional para uma tarefa de engenharia de combate a incêndio. O nome da tarefa é "${nome}" e a unidade de medição é "${unidade}". A descrição deve ser focada em detalhes técnicos relevantes para a medição da obra, como "Instalação da tubulação principal de 4 polegadas. A medição será por metro linear (m)."`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
        };

        try {
            const response = await fetch(`${GEMINI_API_URL_GENERATE}${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const description = result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
            descricaoTextarea.value = description.trim();

        } catch (error) {
            console.error("Erro ao gerar descrição:", error);
            descricaoTextarea.value = "Erro ao gerar descrição. Tente novamente.";
        } finally {
            generateBtn.disabled = false;
            generateBtn.textContent = originalBtnText;
        }
    };

    const openMedicaoForm = (tarefa) => {
        const formHtml = `
            <form id="medicao-form" class="space-y-4">
                <div>
                    <label for="medicao-metragem" class="block text-sm font-medium text-gray-700">Metragem Concluída</label>
                    <input type="number" step="0.01" id="medicao-metragem" name="metragem" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="medicao-observacoes" class="block text-sm font-medium text-gray-700">Observações</label>
                    <textarea id="medicao-observacoes" name="observacoes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">Adicionar Medição</button>
            </form>
        `;
        openModal('Nova Medição', formHtml);
        document.getElementById('medicao-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const metragem = parseFloat(formData.get('metragem'));
            const observacoes = formData.get('observacoes');
            
            // Calculate valor automatically based on valorUnitario
            const valor = tarefa.valorUnitario * metragem;

            const newMedicao = {
                metragem: metragem,
                valor: valor,
                observacoes: observacoes,
                data: new Date().toISOString()
            };
            addMedicaoToTarefa(tarefa.id, newMedicao);
            closeModal();
        });
    };

    const openMedicoesList = (tarefaId, medicoes) => {
        const listHtml = `
            <ul class="space-y-2" id="medicao-list">
                ${medicoes.map((medicao, index) => `
                    <li class="p-4 bg-gray-100 rounded-lg flex justify-between items-center medicoes-list-item">
                        <div>
                            <p><strong>Metragem:</strong> ${medicao.metragem.toFixed(2)}</p>
                            <p><strong>Valor:</strong> ${formatCurrency(medicao.valor)}</p>
                            <p><strong>Observações:</strong> ${medicao.observacoes || 'N/A'}</p>
                            <p class="text-xs text-gray-500">${new Date(medicao.data).toLocaleDateString()}</p>
                        </div>
                        <div>
                            <button class="edit-medicao-btn text-gray-500 hover:text-gray-700" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5.5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293zM14.707 5.293a1 1 0 011.414 0l1.586 1.586a1 1 0 010 1.414l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5.5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293z"></path>
                                </svg>
                            </button>
                        </div>
                    </li>
                `).join('')}
            </ul>
        `;
        openModal('Medições Anteriores', listHtml || '<p>Nenhuma medição registrada.</p>');

        document.querySelectorAll('.edit-medicao-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const medicaoIndex = e.currentTarget.dataset.index;
                const medicao = medicoes[medicaoIndex];
                openEditMedicaoForm(tarefaId, medicaoIndex, medicao);
            });
        });
    };
    
    const openEditMedicaoForm = (tarefaId, medicaoIndex, medicao) => {
        const formHtml = `
            <form id="edit-medicao-form" class="space-y-4">
                <div>
                    <label for="edit-medicao-metragem" class="block text-sm font-medium text-gray-700">Metragem Concluída</label>
                    <input type="number" step="0.01" id="edit-medicao-metragem" name="metragem" value="${medicao.metragem}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="edit-medicao-observacoes" class="block text-sm font-medium text-gray-700">Observações</label>
                    <textarea id="edit-medicao-observacoes" name="observacoes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${medicao.observacoes || ''}</textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">Salvar Alterações</button>
            </form>
        `;
        openModal('Editar Medição', formHtml);
        document.getElementById('edit-medicao-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const metragem = parseFloat(formData.get('metragem'));
            const observacoes = formData.get('observacoes');
            
            const tarefaDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`, tarefaId);
            const tarefaDoc = await getDoc(tarefaDocRef);
            const tarefa = tarefaDoc.data();
            
            const valor = tarefa.valorUnitario * metragem;
            
            const updatedMedicao = {
                metragem: metragem,
                valor: valor,
                observacoes: observacoes,
                data: medicao.data
            };
            
            await updateMedicaoInTarefa(tarefaId, medicaoIndex, updatedMedicao);
            closeModal();
        });
    }

    // Event listeners for main buttons
    addObraBtn.addEventListener('click', () => openObraForm());
    addTarefaBtn.addEventListener('click', () => {
        if (!currentObraId) {
            // Crie um modal customizado no lugar do alert()
            openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
            return;
        }
        openTarefaForm();
    });

    // Run app
    initFirebase();
</script>

</body>
</html>
