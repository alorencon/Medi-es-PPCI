<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medições PPCI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Adicionando biblioteca para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: url('https://i.ibb.co/Kz2Bk089/Apresenta-o-Casa-Castilho-17-Editado.png') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
            color: #000;
        }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #E21B2F; /* Vermelho do logo */
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #c7172a; /* Tom mais escuro */
        }
        .btn-secondary {
            background-color: #e9ecef;
            color: #495057;
        }
        .btn-secondary:hover {
            background-color: #dee2e6;
        }
        .tab-btn {
            flex-grow: 1;
            padding: 1rem;
            border-radius: 9999px;
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
        }
        .tab-btn.active {
            background-color: #494C4F; /* Cinza do logo */
            color: #fff;
        }

        /* Estilos para campos de input para garantir visibilidade */
        input[type="text"], input[type="number"], input[type="date"], textarea, select {
            color: #000;
        }

        .medicoes-list-item {
            color: #000;
        }

        /* Estilos para a aba de Cronograma */
        .gantt-container {
            overflow-x: auto;
            margin-bottom: 2rem;
        }
        .gantt-chart {
            min-width: 100%;
            display: grid;
            grid-template-columns: 200px repeat(30, 1fr);
            gap: 2px;
            margin-top: 1rem;
        }
        .gantt-header {
            background-color: #494C4F;
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-weight: bold;
        }
        .gantt-task {
            background-color: #e9ecef;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 2px;
            cursor: move;
        }
        .gantt-cell {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            min-height: 40px;
        }
        .gantt-cell.active {
            background-color: #E21B2F;
            opacity: 0.6;
        }

        /* Estilo para a Curva S */
        .curva-s-container {
            margin-top: 2rem;
            height: 300px;
        }

        /* Estilo para a lista de despesas */
        .despesa-item {
            border-left: 4px solid #E21B2F;
            padding-left: 1rem;
            margin-bottom: 1rem;
            color: #000;
        }
        
        /* Estilo para formulários de despesas */
        .despesa-form label {
            color: #000;
        }
        .despesa-form input, .despesa-form select, .despesa-form textarea {
            color: #000;
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <!-- Header -->
    <div id="header-container" class="flex items-center justify-between mb-8 flex-wrap">
        <div class="flex items-center space-x-4 mb-4 md:mb-0">
            <img src="https://storage.googleapis.com/ecdt-logo-saida/721cb85e8ac2d398795a63e738d194fd4ab80aca16543ac9858e119ba5215aa7/CASA-CASTILHO-COM-DE-EXTINTORES-E-EQUIPAMENTOS-DE-SEGUR.webp" alt="Logo" class="w-20 h-20">
            <div>
                <h1 class="text-3xl font-bold text-white">Medições PPCI</h1>
                <p class="text-white">Sistema de Gestão de Obras</p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <span class="text-white">ID: <span id="userIdDisplay" class="font-mono"></span></span>
            <button id="logout-btn" class="btn btn-secondary">Sair</button>
        </div>
    </div>
    
    <!-- Login/Main Content -->
    <div id="main-content">
        <!-- Login Page (Default View) -->
        <div id="login-view" class="card">
            <h2 class="text-2xl font-semibold mb-4 text-center">Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="login-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <button type="submit" id="login-btn" class="btn btn-primary w-full">Entrar</button>
                <button type="button" id="create-account-btn" class="btn btn-secondary w-full">Criar Conta</button>
            </form>
        </div>

        <!-- App Main Content (hidden by default) -->
        <div id="app-view" class="hidden">
            <!-- Tabs -->
            <div class="flex flex-wrap bg-gray-200 p-2 rounded-full space-x-2 mb-8">
                <button class="tab-btn active" data-tab="obras">Obras</button>
                <button class="tab-btn" data-tab="tarefas">Tarefas</button>
                <button class="tab-btn" data-tab="cronograma">Cronograma</button>
                <button class="tab-btn" data-tab="relatorios">Relatórios</button>
                <button class="tab-btn" data-tab="despesas">Despesas</button>
            </div>

            <!-- Main Content Area -->
            <div id="content" class="card">
                <!-- Obras Section (Default View) -->
                <div id="obras-view" class="tab-content active">
                    <!-- Conteúdo existente de obras -->
                </div>

                <!-- Tarefas Section -->
                <div id="tarefas-view" class="tab-content hidden">
                    <!-- Conteúdo existente de tarefas -->
                </div>

                <!-- Cronograma Section -->
                <div id="cronograma-view" class="tab-content hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold mb-2 md:mb-0">Cronograma da Obra</h2>
                        <button id="gerar-cronograma-btn" class="btn btn-primary flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                            </svg>
                            <span>Gerar Cronograma</span>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <label for="cronograma-dias" class="block text-sm font-medium text-gray-700">Duração do Cronograma (dias)</label>
                        <input type="number" id="cronograma-dias" min="1" value="30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Tarefas do Cronograma</h3>
                        <div id="tarefas-cronograma" class="space-y-2">
                            <!-- Tarefas serão adicionadas aqui -->
                        </div>
                    </div>
                    
                    <div class="gantt-container">
                        <div id="gantt-chart" class="gantt-chart">
                            <!-- Gráfico de Gantt será gerado aqui -->
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold mb-4 mt-8">Curva S - Evolução Financeira</h3>
                    <div class="curva-s-container">
                        <canvas id="curva-s-chart"></canvas>
                    </div>
                </div>

                <!-- Relatórios Section -->
                <div id="relatorios-view" class="tab-content hidden">
                    <!-- Conteúdo existente de relatórios -->
                </div>

                <!-- Despesas Section -->
                <div id="despesas-view" class="tab-content hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold mb-2 md:mb-0">Despesas da Obra</h2>
                        <div class="flex space-x-2">
                            <button id="add-despesa-btn" class="btn btn-primary flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                <span>Nova Despesa</span>
                            </button>
                            <button id="relatorio-despesas-btn" class="btn btn-secondary flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                <span>Relatório PDF</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <p class="text-gray-500">Total de Despesas</p>
                            <p id="total-despesas" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <p class="text-gray-500">Maior Despesa</p>
                            <p id="maior-despesa" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <p class="text-gray-500">Média por Dia</p>
                            <p id="media-despesas" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                    
                    <div id="despesas-list" class="space-y-4">
                        <!-- Lista de despesas será renderizada aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-xl">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modal-title" class="text-xl font-bold">Título do Modal</h3>
            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <div id="modal-body">
            <!-- Modal form will be rendered here -->
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, getDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // Set Firebase log level for debugging
    setLogLevel('Debug');

    const firebaseConfig = {
        apiKey: "AIzaSyDrTvlOw8Ug2-GvBa2hkqDYKF7avhZ5cFA",
        authDomain: "medicoes-ppci.firebaseapp.com",
        projectId: "medicoes-ppci",
        storageBucket: "medicoes-ppci.firebasestorage.app",
        messagingSenderId: "408815173796",
        appId: "1:408815173796:web:efd25d921a7f0ee923e631",
        measurementId: "G-9YW2XQH2HH"
    };

    const API_KEY = ''; 

    // Variáveis que podem ser definidas pelo ambiente de execução (não altere)
    const __app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : firebaseConfig.appId;
    const __firebase_config = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : firebaseConfig;
    const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : undefined;

    let app;
    let auth;
    let db;
    let userId = null;
    let audioContext;

    let currentObraId = null;
    let curvaSChart = null;

    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const addObraBtn = document.getElementById('add-obra-btn');
    const addTarefaBtn = document.getElementById('add-tarefa-btn');
    const gerarCronogramaBtn = document.getElementById('gerar-cronograma-btn');
    const addDespesaBtn = document.getElementById('add-despesa-btn');
    const relatorioDespesasBtn = document.getElementById('relatorio-despesas-btn');
    const obrasList = document.getElementById('obras-list');
    const tarefasList = document.getElementById('tarefas-list');
    const relatorioContent = document.getElementById('relatorio-content');
    const despesasList = document.getElementById('despesas-list');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const ganttChart = document.getElementById('gantt-chart');
    const cronogramaDias = document.getElementById('cronograma-dias');
    const tarefasCronograma = document.getElementById('tarefas-cronograma');

    const GEMINI_API_URL_GENERATE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
    const GEMINI_API_URL_TTS = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=';

    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const logoutBtn = document.getElementById('logout-btn');
    const loginForm = document.getElementById('login-form');
    const loginBtn = document.getElementById('login-btn');
    const createAccountBtn = document.getElementById('create-account-btn');

    // Utility function to format currency
    const formatCurrency = (value) => {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    };

    // Utility function to calculate percentage
    const calculatePercentage = (numerator, denominator) => {
        if (denominator === 0) return 0;
        return (numerator / denominator) * 100;
    };

    // Modal functions
    const openModal = (title, content) => {
        modalTitle.textContent = title;
        modalBody.innerHTML = content;
        modal.classList.remove('hidden');
    };

    const closeModal = () => {
        modal.classList.add('hidden');
        modalTitle.textContent = '';
        modalBody.innerHTML = '';
    };

    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });

    // Tab switching logic
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.add('hidden'));

            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-view`).classList.remove('hidden');

            if (tab.dataset.tab === 'tarefas') {
                if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click(); // Go back to obras tab
                } else {
                    renderTarefas();
                }
            } else if (tab.dataset.tab === 'relatorios') {
                 if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click(); // Go back to obras tab
                } else {
                    renderRelatorios();
                }
            } else if (tab.dataset.tab === 'cronograma') {
                 if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click(); // Go back to obras tab
                } else {
                    renderTarefasCronograma();
                }
            } else if (tab.dataset.tab === 'despesas') {
                 if (!currentObraId) {
                    openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
                    tabs[0].click(); // Go back to obras tab
                } else {
                    renderDespesas();
                }
            }
        });
    });

    // Firebase Initialization & Auth
    const initFirebase = async () => {
        try {
            app = initializeApp(__firebase_config);
            auth = getAuth(app);
            db = getFirestore(app);
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    listenToObras();
                } else {
                    userId = null;
                    userIdDisplay.textContent = "N/A";
                    loginView.classList.remove('hidden');
                    appView.classList.add('hidden');
                }
            });

        } catch (error) {
            console.error("Erro ao inicializar Firebase ou autenticar:", error);
        }
    };
    
    loginBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            openModal('Erro de Login', `<p class="text-center text-gray-700">Ocorreu um erro ao fazer login: ${error.message}</p>`);
        }
    });
    
    createAccountBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            openModal('Sucesso', '<p class="text-center text-green-600">Conta criada com sucesso! Você foi logado automaticamente.</p>');
        } catch (error) {
            openModal('Erro ao Criar Conta', `<p class="text-center text-gray-700">Ocorreu um erro ao criar a conta: ${error.message}</p>`);
        }
    });

    logoutBtn.addEventListener('click', async () => {
        await signOut(auth);
        currentObraId = null; // Reset current obra
        tabs[0].click(); // Go back to obras tab
    });

    // Firestore CRUD Operations
    const listenToObras = () => {
        if (!db || !userId) {
            console.error("Firestore ou UserID não inicializados. Tente novamente.");
            return;
        }
        const obrasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras`);
        onSnapshot(obrasRef, (snapshot) => {
            const obras = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderObras(obras);
        });
    };

    // ... (outras funções CRUD existentes)

    // CRUD para Despesas
    const addOrUpdateDespesa = async (despesa) => {
        if (!currentObraId) return;
        const despesasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/despesas`);
        if (despesa.id) {
            const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/despesas`, despesa.id);
            await updateDoc(docRef, despesa);
        } else {
            const { id, ...newDespesaData } = despesa;
            await addDoc(despesasRef, newDespesaData);
        }
        closeModal();
    };

    const deleteDespesa = async (despesaId) => {
        const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/despesas`, despesaId);
        await deleteDoc(docRef);
    }

    // Render functions
    const renderObras = (obras) => {
        // Implementação existente
    };

    const renderTarefas = () => {
        // Implementação existente
    };

    // Renderização de Tarefas para Cronograma
    const renderTarefasCronograma = async () => {
        if (!currentObraId) return;

        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        const snapshot = await getDocs(tarefasRef);
        const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        tarefasCronograma.innerHTML = '';
        
        tarefas.forEach(tarefa => {
            const tarefaItem = document.createElement('div');
            tarefaItem.className = 'flex items-center justify-between p-2 bg-gray-100 rounded';
            tarefaItem.innerHTML = `
                <span class="font-medium">${tarefa.nome}</span>
                <div class="flex items-center">
                    <label class="mr-2 text-sm">Duração (dias):</label>
                    <input type="number" min="1" value="5" class="w-16 p-1 border rounded" data-id="${tarefa.id}">
                </div>
            `;
            tarefasCronograma.appendChild(tarefaItem);
        });
    };

    // Renderização do Cronograma
    const renderCronograma = async () => {
        if (!currentObraId) return;

        // Carregar tarefas
        const tarefasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/tarefas`);
        const snapshot = await getDocs(tarefasRef);
        const tarefas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Obter durações das tarefas
        const duracoes = {};
        document.querySelectorAll('#tarefas-cronograma input').forEach(input => {
            duracoes[input.dataset.id] = parseInt(input.value) || 1;
        });

        const dias = parseInt(cronogramaDias.value) || 30;

        // Gerar cabeçalho do gráfico de Gantt
        ganttChart.innerHTML = '';
        
        // Linha de cabeçalho com dias
        let headerRow = document.createElement('div');
        headerRow.className = 'gantt-header';
        headerRow.textContent = 'Tarefa';
        ganttChart.appendChild(headerRow);
        
        for (let i = 1; i <= dias; i++) {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'gantt-header';
            dayHeader.textContent = i;
            ganttChart.appendChild(dayHeader);
        }

        // Adicionar tarefas ao gráfico
        let startDay = 1;
        tarefas.forEach(tarefa => {
            const duracao = duracoes[tarefa.id] || 1;
            
            // Linha da tarefa
            const taskRow = document.createElement('div');
            taskRow.className = 'gantt-task';
            taskRow.textContent = tarefa.nome;
            ganttChart.appendChild(taskRow);

            // Células para cada dia
            for (let i = 1; i <= dias; i++) {
                const cell = document.createElement('div');
                cell.className = 'gantt-cell';
                if (i >= startDay && i < startDay + duracao) {
                    cell.classList.add('active');
                }
                ganttChart.appendChild(cell);
            }
            
            startDay += duracao;
        });

        // Renderizar Curva S
        renderCurvaS(tarefas, duracoes, dias);
    };

    const renderCurvaS = (tarefas, duracoes, diasTotal) => {
        const ctx = document.getElementById('curva-s-chart').getContext('2d');
        
        if (curvaSChart) {
            curvaSChart.destroy();
        }
        
        // Calcular a curva S baseada nas tarefas e durações
        const labels = Array.from({length: diasTotal}, (_, i) => `Dia ${i+1}`);
        
        // Calcular o valor total da obra
        const valorTotal = tarefas.reduce((sum, t) => sum + (t.valorTotal || 0), 0);
        
        // Calcular o valor planejado por dia
        const plannedData = new Array(diasTotal).fill(0);
        let day = 0;
        
        tarefas.forEach(tarefa => {
            const duracao = duracoes[tarefa.id] || 1;
            const valorPorDia = (tarefa.valorTotal || 0) / duracao;
            
            for (let i = 0; i < duracao && day < diasTotal; i++, day++) {
                plannedData[day] = (day > 0 ? plannedData[day-1] : 0) + valorPorDia;
            }
        });
        
        // Calcular o valor realizado (baseado nas medições)
        const actualData = new Array(diasTotal).fill(0);
        let currentValor = 0;
        
        tarefas.forEach(tarefa => {
            const valorMedido = (tarefa.medicoes || []).reduce((sum, medicao) => sum + (medicao.valor || 0), 0);
            currentValor += valorMedido;
        });
        
        // Distribuir o valor realizado ao longo do tempo (simulação)
        for (let i = 0; i < diasTotal; i++) {
            const progresso = Math.min(1, i / (diasTotal * 0.8)); // Simulação de progresso
            actualData[i] = currentValor * progresso;
        }
        
        curvaSChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Planejado',
                        data: plannedData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Realizado',
                        data: actualData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Curva S - Evolução Financeira'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Valor (R$)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Tempo (dias)'
                        }
                    }
                }
            }
        });
    };

    // Renderização de Despesas
    const renderDespesas = () => {
        if (!currentObraId) return;

        const despesasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/despesas`);
        onSnapshot(despesasRef, (snapshot) => {
            despesasList.innerHTML = '';
            const despesas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            let total = 0;
            let maiorDespesa = 0;
            
            despesas.forEach(despesa => {
                total += despesa.valor;
                if (despesa.valor > maiorDespesa) {
                    maiorDespesa = despesa.valor;
                }
                
                const despesaItem = document.createElement('div');
                despesaItem.className = 'despesa-item';
                despesaItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${despesa.descricao}</p>
                            <p class="text-sm text-gray-500">${new Date(despesa.data).toLocaleDateString()} - ${despesa.categoria}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-red-600 font-bold">${formatCurrency(despesa.valor)}</p>
                            <div class="flex space-x-2 mt-2">
                                <button class="edit-despesa-btn text-gray-500 hover:text-gray-700" data-id="${despesa.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5 5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293zM14.707 5.293a1 1 0 011.414 0l1.586 1.586a1 1 0 010 1.414l-7.293 7.293a1 1 0 01-.39.293l-2.426.809a.5 5 0 01-.639-.639l.809-2.426a1 1 0 01.293-.39l7.293-7.293z"></path>
                                    </svg>
                                </button>
                                <button class="delete-despesa-btn text-gray-500 hover:text-gray-700" data-id="${despesa.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                despesasList.appendChild(despesaItem);
            });
            
            // Atualizar totais
            document.getElementById('total-despesas').textContent = formatCurrency(total);
            document.getElementById('maior-despesa').textContent = formatCurrency(maiorDespesa);
            
            // Calcular média por dia (considerando últimos 30 dias)
            const media = total / 30;
            document.getElementById('media-despesas').textContent = formatCurrency(media);
            
            // Adicionar event listeners para editar e excluir
            document.querySelectorAll('.edit-despesa-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const despesaId = e.currentTarget.dataset.id;
                    const despesa = despesas.find(d => d.id === despesaId);
                    openDespesaForm(despesa);
                });
            });
            
            document.querySelectorAll('.delete-despesa-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const despesaId = e.currentTarget.dataset.id;
                    openModal('Confirmar Exclusão', `
                        <p class="text-center text-gray-700 mb-4">Tem certeza que deseja deletar esta despesa?</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmDeleteBtn" class="btn btn-primary">Sim</button>
                            <button id="cancelDeleteBtn" class="btn btn-secondary">Não</button>
                        </div>
                    `);
                    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                        deleteDespesa(despesaId);
                        closeModal();
                    });
                    document.getElementById('cancelDeleteBtn').addEventListener('click', closeModal);
                });
            });
            
            // Se não houver despesas, mostrar mensagem
            if (despesas.length === 0) {
                despesasList.innerHTML = '<p class="text-center text-gray-500">Nenhuma despesa registrada.</p>';
            }
        });
    };

    // Formulário para Despesas
    const openDespesaForm = (despesa = {}) => {
        const formHtml = `
            <form id="despesa-form" class="space-y-4 despesa-form">
                <div>
                    <label for="despesa-descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <input type="text" id="despesa-descricao" name="descricao" value="${despesa.descricao || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="despesa-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                    <input type="number" step="0.01" id="despesa-valor" name="valor" value="${despesa.valor || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="despesa-data" class="block text-sm font-medium text-gray-700">Data</label>
                    <input type="date" id="despesa-data" name="data" value="${despesa.data || new Date().toISOString().split('T')[0]}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="despesa-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="despesa-categoria" name="categoria" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        <option value="Gasolina" ${despesa.categoria === 'Gasolina' ? 'selected' : ''}>Gasolina</option>
                        <option value="Alimentação" ${despesa.categoria === 'Alimentação' ? 'selected' : ''}>Alimentação</option>
                        <option value="Hospedagem" ${despesa.categoria === 'Hospedagem' ? 'selected' : ''}>Hospedagem</option>
                        <option value="Materiais" ${despesa.categoria === 'Materiais' ? 'selected' : ''}>Materiais</option>
                        <option value="Outros" ${despesa.categoria === 'Outros' ? 'selected' : ''}>Outros</option>
                    </select>
                </div>
                <div>
                    <label for="despesa-observacoes" class="block text-sm font-medium text-gray-700">Observações</label>
                    <textarea id="despesa-observacoes" name="observacoes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${despesa.observacoes || ''}</textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">${despesa.id ? 'Atualizar' : 'Salvar'}</button>
            </form>
        `;
        openModal(despesa.id ? 'Editar Despesa' : 'Nova Despesa', formHtml);
        document.getElementById('despesa-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newDespesa = {
                descricao: formData.get('descricao'),
                valor: parseFloat(formData.get('valor')),
                data: formData.get('data'),
                categoria: formData.get('categoria'),
                observacoes: formData.get('observacoes')
            };
            addOrUpdateDespesa({ ...newDespesa, id: despesa.id });
        });
    };

    // Relatório de Despesas em PDF
    const exportDespesasPDF = async () => {
        if (!currentObraId) return;
        
        const despesasRef = collection(db, `artifacts/${__app_id}/users/${userId}/obras/${currentObraId}/despesas`);
        const snapshot = await getDocs(despesasRef);
        const despesas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const obraDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/obras`, currentObraId);
        const obraDoc = await getDoc(obraDocRef);
        const obra = obraDoc.data();
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text(`Relatório de Despesas - ${obra.nome}`, 14, 22);
        
        doc.setFontSize(12);
        doc.text(`Data de emissão: ${new Date().toLocaleDateString()}`, 14, 30);
        
        // Calcular totais
        const total = despesas.reduce((sum, d) => sum + d.valor, 0);
        doc.text(`Total de despesas: ${formatCurrency(total)}`, 14, 38);
        
        // Tabela de despesas
        const columns = ["Descrição", "Categoria", "Data", "Valor (R$)"];
        const rows = despesas.map(item => [
            item.descricao,
            item.categoria,
            new Date(item.data).toLocaleDateString(),
            item.valor.toFixed(2)
        ]);
        
        doc.autoTable({
            head: [columns],
            body: rows,
            startY: 45,
            theme: 'grid',
            headStyles: { fillColor: [226, 27, 47] }, // Vermelho da empresa
        });
        
        doc.save(`relatorio_despesas_${obra.nome}_${new Date().toISOString().split('T')[0]}.pdf`);
    };

    // Event listeners for main buttons
    addObraBtn.addEventListener('click', () => openObraForm());
    addTarefaBtn.addEventListener('click', () => {
        if (!currentObraId) {
            openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
            return;
        }
        openTarefaForm();
    });
    
    gerarCronogramaBtn.addEventListener('click', () => {
        if (!currentObraId) {
            openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
            return;
        }
        renderCronograma();
    });
    
    addDespesaBtn.addEventListener('click', () => {
        if (!currentObraId) {
            openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
            return;
        }
        openDespesaForm();
    });
    
    relatorioDespesasBtn.addEventListener('click', () => {
        if (!currentObraId) {
            openModal('Atenção', '<p class="text-center text-gray-700">Por favor, selecione uma obra primeiro.</p>');
            return;
        }
        exportDespesasPDF();
    });

    // Run app
    initFirebase();
</script>
</body>
</html>
